#pragma rtGlobals=1		// Use modern global access method.Function Step_curveFit(ctrlname)		String ctrlname	DFREF DF=GetDatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common=$(DF_panel+":panel_common")	SetActiveSubwindow $winname(0,65)	DFREF DFR_fit=$(DF_panel+":Fit_data")		SetDatafolder DFR_panel		Wave /B FitFnName_list_sel=DFR_fit:FitFnName_list_sel		NVAR gv_pathnum=DFR_panel:gv_pathnum		NVAR gv_protectflag=DFR_panel:gv_protectflag	NVAR gv_ignorefitflag=DFR_panel:gv_ignorefitflag		Variable index=0	Variable fitcontrolflag=0	variable fitdirectionflag=0 //0 down //1 up	Variable copycoefflag=0 //0 fit // 1 only update coef				if (stringmatch(ctrlname,"Fit_bt1")==1)		fitdirectionflag=1		index=dimsize(FitFnName_list_sel,0)-1	endif		do 		if (fitdirectionflag==0)			if (index>=dimsize(FitFnName_list_sel,0))			break			endif		else			if (index<0)			break			endif		endif			if (FitFnName_list_sel[index][0][0]==1)					if (fitcontrolflag==0)				gv_pathnum=index				update_fit_wave(1)				Update_par_list(1)				update_display_curve(1)				fitcontrolflag+=1			else				gv_pathnum=index				update_fit_wave(1)				Update_par_list(0)				//update_listbox_to_SavePara()				update_display_curve(1)				fitcontrolflag+=1			endif					if (gv_ignorefitflag)				update_Coef_to_Listbox()				update_coef_to_SavePara()				update_display_curve(1)			else						if (ARPES_CurveFit("dummy")==0)					fitcontrolflag=2					break				endif			endif			endif			if  (fitdirectionflag==0)			index+=1		else			index-=1		endif	while (1)//index<dimsize(FitFnName_list_sel,0))		if (fitcontrolflag==1)		if  (fitdirectionflag==0)			gv_pathnum+=1		else			gv_pathnum-=1		endif		update_fit_wave(1)		Update_par_list(0)		//update_listbox_to_SavePara()		update_display_curve(1)				if (gv_ignorefitflag)			update_Coef_to_Listbox()			update_coef_to_SavePara()			update_display_curve(1)		else			ARPES_CurveFit("dummy")		endif	endif		WAVE /B FitFnName_list_sel=DFR_fit:FitFnName_list_sel	FitFnName_list_sel[][][0]=0	FitFnName_list_sel[gv_pathnum][0][0]=1		//fitpanel#Fitproc_Listbox_proc("dummy",gv_pathnum,0,4)  		SetDatafolder DFendFunction ARPES_CurveFit(ctrlname)	String ctrlname	DFREF DF=GetDatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common=$(DF_panel+":panel_common")	SetActiveSubwindow $winname(0,65)	DFREF DFR_fit=$(DF_panel+":Fit_data")		SetDatafolder DFR_panel		NVAR gv_fit_leftrange=DFR_panel:gv_fit_leftrange	NVAR gv_fit_rightrange=DFR_panel:gv_fit_rightrange		update_fit_range()		Wave /B FitFnName_list_sel=DFR_fit:FitFnName_list_sel		NVAR gv_pathnum=DFR_panel:gv_pathnum			Wave w_trace=DFR_common:w_trace			SVAR CurveFit_hdstr=DFR_panel:CurveFit_hdstr		NVAR gv_confInterval=DFR_panel:gv_confInterval		Wave /T Fit_Constrain_list=DFR_panel:Fit_Constrain_list				Wave CurveFit_coef=DFR_panel:CurveFit_coef			NVAR gv_weightflag=DFR_panel:gv_weightflag				duplicate /o CurveFit_coef,CurveFit_epsilon				CurveFit_epsilon=1e-5//*wavemax(w_trace)			duplicate /o w_trace w_res			Variable destnum=abs((gv_fit_rightrange-gv_fit_leftrange)/dimdelta(w_trace,0))				if (gv_weightflag)			Wave /Z w_weight=DFR_panel:w_weight			if (Waveexists(w_weight)==0)				duplicate /o w_trace w_weight				w_weight=1			endif						duplicate /o w_trace w_weight_proc			w_weight_proc=w_weight(x)*returnDefaultweight(w_trace,gv_fit_leftrange,gv_fit_rightrange,1)		endif										//sdc 20160201				variable gv_fit_leftrange_pnt=min( x2pnt(w_trace,gv_fit_leftrange),x2pnt(w_trace,gv_fit_rightrange))		variable  gv_fit_rightrange_pnt=max( x2pnt(w_trace,gv_fit_leftrange),x2pnt(w_trace,gv_fit_rightrange))										try			if (gv_weightflag==0)				FuncFit/N/Q/L=(abs(destnum))/H=CurveFit_hdstr ARPES_composed_FitFn CurveFit_coef w_trace[gv_fit_leftrange_pnt,gv_fit_rightrange_pnt] /R=w_res/F={gv_confInterval,7}/C=Fit_Constrain_list; AbortOnRTE ///E=CurveFit_epsilon			else				FuncFit/N/Q/L=(abs(destnum))/H=CurveFit_hdstr ARPES_composed_FitFn CurveFit_coef w_trace[gv_fit_leftrange_pnt,gv_fit_rightrange_pnt] /R=w_res/F={gv_confInterval,7}/C=Fit_Constrain_list/I=1/W=w_weight_proc; AbortOnRTE ///E=CurveFit_epsilon			endif		catch			doalert 0,"Fit error, recover the parameter"			//update_listbox_to_coef	()			//update_display_curve(1)			SetDatafolder DF			return 0		endtry				if (x2pnt(w_Res,gv_fit_leftrange)>0)			w_res[0,x2pnt(w_Res,gv_fit_leftrange)]=Nan		endif		if (x2pnt(w_Res,gv_fit_rightrange)<numpnts(w_Res))			w_res[x2pnt(w_Res,gv_fit_rightrange),inf]=Nan		endif				update_listbox_color(1)				update_Coef_to_Listbox()		update_coef_to_SavePara()		update_display_curve(1)					Wave /Z W_sigma						SetDatafolder DF	return 1End
#pragma rtGlobals=1		// Use modern global access method.#pragma version = 2.00#pragma ModuleName = gold#pragma IgorVersion = 5.0////////////////////////////////////////// Public functions////////////////////////////////////////Function gold_open(ctrlName)	String ctrlName	// initialize?	//if (! datafolderexists("root:internalUse:norm"))		norm_init()	//endif		String DF = GetDataFolder (1)	SetDataFolder root:internalUse:norm		DoWindow/K gold_panel	Display/K=1 as "gold panel"	DoWindow/C gold_panel	utils_resizeWindow("gold_panel",510,565)	utils_autoPosWindow("gold_panel", win=127)	String cmd = "ControlBar 213"	execute cmd		Variable r=57000, g=57000, b=57000	// background color for the TabControl	ModifyGraph cbRGB=(42428,42428,42428)	ModifyGraph wbRGB=(65535,56581,45115),gbRGB=(65535,56581,45115)		// controls that do not depend on the tabs	panelcommon_srcListBoxInit()	listbox waves_lb, pos={16,37}, size={130,145}, listwave=root:internalUse:panelcommon:w_sourceNames, selwave=root:internalUse:panelcommon:w_sourceNamesSel, frame=2,mode=4, proc=panelcommon_srcListboxProc, widths={200}		CheckBox n_check0, pos={20,197}, title="suppress par. update"	CheckBox n_check1, pos={160,197}, title="lock DC-intensity scale", proc=panelcommon_checkBoxLockInt	CheckBox n_check2, pos={340,197}, title="integrate E", proc=panelcommon_checkBoxIntEorK	CheckBox n_check3, pos={420,197}, title="integrate k", proc=panelcommon_checkBoxIntEorK		// --------------------------tab-controls -----------------	// source tab	TabControl gold,proc=gold#tabControlChange,pos={8,6},size={494,190},tabLabel(0)="source",value=0,labelBack=(r,g,b), fsize=12	GroupBox sou_gb0, frame=1,labelBack=(r,g,b), pos={170,35}, size={240,149}, title="source folder", fsize=10	listbox sou_lb1, pos={180,60}, size={220,90}, listwave=root:internalUse:panelcommon:w_DF, selrow=0, frame=2,mode=1, proc=panelcommon_srcListboxProc			// Fermi fit	TabControl gold,tabLabel(1)="Fermi"	Variable x4 = 160, y4 = 35	SetVariable fer_sv_0,labelBack=(r,g,b), pos={x4+0,y4+5},size={115,15}, limits={-inf,inf,0}, title="offset",frame=1,fsize=10,value= gv_fp0, disable=1	SetVariable fer_sv_1,labelBack=(r,g,b), pos={x4+0,y4+23},size={115,15}, limits={-inf,inf,0}, title="offset-slope",frame=1,fsize=10,value= gv_fp1, disable=1	SetVariable fer_sv_2,labelBack=(r,g,b), pos={x4+0,y4+41},size={115,15}, limits={-inf,inf,0}, title="dos",frame=1,fsize=10,value= gv_fp2, disable=1	SetVariable fer_sv_3,labelBack=(r,g,b), pos={x4+0,y4+59},size={115,15}, limits={-inf,inf,0}, title="dos-slope",frame=1,fsize=10,value= gv_fp3, disable=1	SetVariable fer_sv_4,labelBack=(r,g,b), pos={x4+0,y4+77},size={115,15}, limits={-inf,inf,0}, title="EF",frame=1,fsize=10,value= gv_fp4, disable=1	SetVariable fer_sv_5,labelBack=(r,g,b), pos={x4+0,y4+95},size={115,15}, limits={-inf,inf,0}, title="Temp.",frame=1,fsize=10,value= gv_fp5, disable=1	SetVariable fer_sv_6,labelBack=(r,g,b), pos={x4+0,y4+113},size={115,15}, limits={-inf,inf,0}, title="resolution",frame=1,fsize=10,value= gv_fp6, disable=1	Button fer_b_0, pos={x4+35,y4+132},size={60,15}, labelback=(r,g,b),title="guess", disable=1, proc=gold#buttonGuessFermi		CheckBox fer_c_0, pos={x4+120,y4+5}, title="",labelBack=(r,g,b), disable=1	CheckBox fer_c_1, pos={x4+120,y4+23}, title="",labelBack=(r,g,b), disable=1	CheckBox fer_c_2, pos={x4+120,y4+41}, title="",labelBack=(r,g,b), disable=1	CheckBox fer_c_3, pos={x4+120,y4+59}, title="",labelBack=(r,g,b), disable=1	CheckBox fer_c_4, pos={x4+120,y4+77}, title="",labelBack=(r,g,b), disable=1	CheckBox fer_c_5, pos={x4+120,y4+95}, title="",labelBack=(r,g,b), disable=1, value=1	CheckBox fer_c_6, pos={x4+120,y4+113}, title="",labelBack=(r,g,b), disable=1		GroupBox fer_gb1, frame=1,labelBack=(r,g,b), pos={x4+150,y4}, size={175,70}, title="fit", fsize=10, disable=1	Button fer_bfitOne, pos={x4+160,y4+17},size={45,16}, labelback=(r,g,b),title="one", disable=1, proc=gold#buttonFitOneOrAll	Button fer_bfitAll, pos={x4+215,y4+17},size={45,16}, labelback=(r,g,b),title="all", disable=1, proc=gold#buttonFitOneOrAll	Button fer_b_3, pos={x4+270,y4+17},size={45,16}, labelback=(r,g,b),title="Nik's", disable=1, proc=gold#buttonNiksPlotFit	CheckBox fer_cbshowDisp, pos={x4+160,y4+36}, title="show dispersion wave",labelBack=(r,g,b), disable=1,proc=gold#buttonShowDispOrRes	CheckBox fer_cbshowRes, pos={x4+160,y4+53}, title="show resolution wave",labelBack=(r,g,b), disable=1, proc=gold#buttonShowDispOrRes			GroupBox fer_gb2, frame=1,labelBack=(r,g,b), pos={x4+150,y4+78}, size={175,75}, title="dispersion wave", fsize=10, disable=1	Button fer_b_4, pos={x4+160,y4+95},size={70,15}, labelback=(r,g,b),title="smooth", disable=1, proc=gold#buttonSmoothDisp	Button fer_b_5, pos={x4+245,y4+95},size={70,15}, labelback=(r,g,b),title="reset", disable=1, proc=gold#buttonResetDisp	Button fer_b_6, pos={x4+160,y4+113},size={70,15}, labelback=(r,g,b),title="save", disable=1, proc=gold#buttonSaveDisp	Button fer_b_7, pos={x4+245,y4+113},size={70,15}, labelback=(r,g,b),title="save raw", disable=1, proc=gold#buttonSaveDisp	SetVariable fer_sv_10,labelBack=(r,g,b), pos={x4+160,y4+132},size={155,15}, title="name base:",frame=1,fsize=10,value= gs_w_dispNameBase, disable=1		//--------------------------------------------------------------------------------------------------------------	TabControl gold,tabLabel(2)="TMF"		GroupBox tmf_gb1, pos={160,35}, size={122,145}, title="integration range", fsize=10, disable=1	SetVariable tmf_sv0,labelBack=(r,g,b), pos={170,55},size={90,15}, limits={-inf,inf,0}, title="E_0:",frame=1,fsize=10,value= gv_tmfE0, disable=1	SetVariable tmf_sv1,labelBack=(r,g,b), pos={170,75},size={90,15}, limits={-inf,inf,0}, title="E_1:",frame=1,fsize=10,value= gv_tmfE1, disable=1	Button tmf_b4, pos={170,100}, size={30,14}, labelback=(r,g,b), title="m", proc=gold#buttonReadMarquee, disable=1	Button tmf_blow, pos={170,120}, size={30,14}, labelback=(r,g,b), title="low", proc=gold#buttonDefaultE0E1, disable=1	Button tmf_bhigh, pos={170,140}, size={30,14}, labelback=(r,g,b), title="high", proc=gold#buttonDefaultE0E1, disable=1	TitleBox tmf_t4, pos={205,101}, size={80,12}, frame=0,title="read marquee", disable=1	TitleBox tmf_t5, pos={205,121}, size={80,12}, frame=0,title="default low", disable=1	TitleBox tmf_t6, pos={205,141}, size={80,12}, frame=0,title="default high", disable=1		GroupBox tmf_gb10, frame=1,labelBack=(r,g,b), pos={298,35}, size={180,145}, title="generate/save TMF", fsize=10, disable=1	CheckBox tmf_c10, pos={390,60}, title="show wave",labelBack=(r,g,b), proc=gold#buttonShowTMF, disable=1	Button tmf_b10, pos={308,60},size={70,15}, labelback=(r,g,b),title="integrate", disable=1, proc=gold#buttonNewTMF	Button tmf_b11, pos={308,80},size={70,15}, labelback=(r,g,b),title="smooth", disable=1, proc=gold#buttonSmoothDisp	Button tmf_b12, pos={308,100},size={70,15}, labelback=(r,g,b),title="reset", disable=1, proc=gold#buttonResetDisp	Button tmf_b13, pos={388,130},size={70,15}, labelback=(r,g,b),title="smoothed", disable=1, proc=gold#buttonSaveDisp	Button tmf_b14, pos={308,130},size={70,15}, labelback=(r,g,b),title="save raw", disable=1, proc=gold#buttonSaveDisp	SetVariable tmf_sv10,labelBack=(r,g,b), pos={308,150},size={150,15}, title="name base:",frame=1,fsize=10,value= gs_w_dispNameBase, disable=1			panelcommon_addImage("gold_panel")	gold_panel_SLB_proc()		SetDataFolder $DFEnd////////////////////////////////////////// Private functions: Control Callbacks////////////////////////////////////////// data-rangeStatic Function buttonReadMarquee(ctrlName)	String ctrlName	NVAR e0 = root:internalUse:norm:gv_tmfE0	NVAR e1 = root:internalUse:norm:gv_tmfE1		GetMarquee/K image_en, image_m	if (v_flag == 0)		DoAlert 0, "You need to set a marquee first (this is the rectangle, you usually use to expand a graph)."	endif	e0 = V_bottom	e1 = V_topEndStatic Function buttonDefaultE0E1(ctrlname)	String ctrlname		Variable n = 30	// lowest or highest n-MDC's to average	WAVE M = root:internalUse:panelcommon:w_image	NVAR e0 = root:internalUse:norm:gv_tmfE0	NVAR e1 = root:internalUse:norm:gv_tmfE1		if(stringmatch(ctrlName, "tmf_blow"))		// low		e0 = dimoffset(M,1)		e1 = e0 + n * dimdelta(M,1)	elseif(stringmatch(ctrlName, "tmf_bhigh"))	// high		e0 = utils_y1(M) - n* dimdelta(M,1)		e1 = utils_y1(M)	endifEndStatic Function buttonGuessFermi(ctrlName)	String ctrlname		String Df = getdatafolder (1)	SetDataFolder root:internaluse:norm		NVAR fp0 = gv_fp0; NVAR fp1 = gv_fp1; NVAR fp2 = gv_fp2; NVAR fp3 = gv_fp3		NVAR fp4 = gv_fp4; NVAR fp5 = gv_fp5; NVAR fp6 = gv_fp6		WAVE temp_EDC = root:internalUse:panelcommon:n_EDC	wavestats/Q temp_EDC	Duplicate/o temp_EDC w_guess	Smooth 13, w_guess	Differentiate w_guess	// now we should have a Gaussian	CurveFit/q gauss w_guess 	WAVE w_coef	KillWaves/ z w_guess		fp0 = v_min	fp1 = 0	fp2 = v_max-v_min	fp3 = 0	fp4 = w_coef[2]	fp5 = 10	fp6 = sqrt((2.335* w_coef[3])^2 - (13 * deltax(temp_EDC))^2)	// igor width to full width & corrected for smoothing broadening		Make/d/o/n=7 FF_pw={fp0, fp1, fp2, fp3, fp4, fp5, fp6}		SetDataFolder $DFEndStatic Function buttonShowDispOrRes(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked		String DF = GetDataFolder (1)	SetDataFolder root:internalUse:norm	NVAR fp4 = gv_fp4	NVAR fp6 = gv_fp6	WAVE w_image = root:internalUse:panelcommon:w_image	WAVE w_dispersion	WAVE w_resolution	WAVE n_mdc = root:internalUse:panelcommon:n_mdc		if(stringmatch(ctrlName,"fer_cbshowDisp"))		// show dispersion		if(checked)			if (!waveexists(w_dispersion))				buttonGuessFermi("dummy")				make_w_disp(w_image)				WAVE w_dispersion				w_dispersion = fp4						endif						CheckBox fer_cbshowRes, value = 0	// uncheck the other box			AppendToGraph w_dispersion			ModifyGraph mode(w_dispersion)=3,marker(w_dispersion)=19,msize(w_dispersion)=1			RemoveFromGraph/Z n_mdc, w_resolution, w_norm		else			if (!waveexists(w_dispersion))				return -1			endif			AppendToGraph n_mdc			ModifyGraph rgb(n_mdc)=(1,16019,65535)			RemoveFromGraph/Z w_dispersion, w_dispersion_s, w_norm		endif	elseif(stringmatch(ctrlName,"fer_cbshowRes"))		// show resolution		if(checked)			if (!waveexists(w_resolution))				buttonGuessFermi("dummy")				make_w_disp(w_image)				WAVE w_resolution				w_resolution = fp6			endif			CheckBox fer_cbshowDisp, value = 0			AppendToGraph w_resolution			ModifyGraph mode(w_resolution)=3,marker(w_resolution)=19,msize(w_resolution)=1			RemoveFromGraph/Z n_mdc, w_dispersion, w_dispersion_s, w_norm		else			if (!waveexists(w_resolution))				return -1			endif			AppendToGraph n_mdc			ModifyGraph rgb(n_mdc)=(1,16019,65535)			RemoveFromGraph/Z w_resolution, w_norm		endif	endif	SetDataFolder $DFEndStatic Function buttonShowTMF(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked		String DF = GetDataFolder (1)	SetDataFolder root:internalUse:norm		WAVE w_image = root:internalUse:panelcommon:w_image	WAVE n_mdc = root:internalUse:panelcommon:n_mdc	WAVE w_dispersion = root:internalUse:norm:w_dispersion			if(checked)			if (!waveexists(w_dispersion))				make_w_disp(w_image)				WAVE w_dispersion			endif						AppendToGraph w_dispersion			RemoveFromGraph/Z n_mdc		else			AppendToGraph n_mdc			ModifyGraph rgb(n_mdc)=(1,16019,65535)			RemoveFromGraph/Z w_dispersion		endif	SetDataFolder $DFEndStatic Function buttonNewTMF(ctrlName)	String ctrlName		NVAR from = root:internalUse:norm:gv_tmfE0	NVAR to = root:internalUse:norm:gv_tmfE1	WAVE w_image = root:internalUse:panelcommon:w_image	WAVE w_tmf = root:internalUse:norm:w_dispersion		make_w_disp(w_image)		utils_getWaveAvg(w_image,0,from=from,to=to)	WAVE w_avg	w_tmf = w_avg	KillWaves/Z w_avgEndStatic Constant kTabSource = 0Static Constant kTabFermi = 1Static Function tabControlChange( name, tab )	String name	Variable tab		// Get the name of the current tab	ControlInfo $name	String tabStr = S_Value	tabStr = tabStr[0,2]		// Get a list of all the controls in the window	Variable i = 0	String all = ControlNameList( "gold_panel" )	String thisControl		do		thisControl = StringFromList( i, all )		if( strlen( thisControl ) <= 0 )			break		endif				// Found another control.  Does it start with two letters and an underscore?		if( !CmpStr( thisControl[3], "_" ) )			// If it matches the current tab, show it.  Otherwise, hide it			if( !CmpStr( thisControl[0,2], tabStr ) )				utils_setControlEnabled( thisControl, 0 )			else				utils_setControlEnabled( thisControl, 1)			endif		endif		i += 1	while( 1 )		String Df = GetDataFolder (1)		// tab-specific adjustments	if ( tab != kTabFermi )	// not on the Fermi-tab -> switch back to mdc-display		AppendToGraph root:internalUse:panelcommon:n_edc	// first append a dummy to avoid having no wave on the graph		RemoveFromGraph/Z n_Ffit_x, n_mdc, w_dispersion		RemoveFromGraph/Z w_dispersion_s, w_resolution		AppendToGraph root:internalUse:panelcommon:n_mdc		ModifyGraph rgb(n_mdc)=(1,16019,65535)		RemoveFromGraph/Z  n_EDC		CheckBox fer_cbshowDisp, value=0		CheckBox fer_cbshowRes, value=0	endif		switch( tab )		case kTabFermi:				AppendToGraph root:internalUse:panelcommon:n_edc				RemoveFromGraph/Z w_norm, n_mdc				AppendToGraph root:internalUse:panelcommon:n_mdc				ModifyGraph rgb(n_mdc)=(1,16019,65535)				RemoveFromGraph/Z n_edc			break		case kTabSource:				AppendToGraph root:internalUse:panelcommon:n_edc				RemoveFromGraph/Z w_norm, n_mdc				AppendToGraph root:internalUse:panelcommon:n_mdc				ModifyGraph rgb(n_mdc)=(1,16019,65535)				RemoveFromGraph/Z n_edc			break	endswitch		SetDataFolder $DFEnd// "gold panel"		FB  07/24/03///////////////////////////////////////////////////////////////////////////////////////////////////////////Static Function buttonFitOneOrAll(ctrlName)	String ctrlName		String Df = getdatafolder (1)	SetDataFolder root:internalUse:norm		NVAR fp0 = gv_fp0		NVAR fp1 = gv_fp1		NVAR fp2 = gv_fp2		NVAR fp3 = gv_fp3		NVAR fp4 = gv_fp4	NVAR fp5 = gv_fp5	NVAR fp6 = gv_fp6		WAVE FF_pw	FF_pw = {fp0, fp1, fp2, fp3, fp4, fp5, fp6}	WAVE n_EDC = root:internalUse:panelcommon:n_edc	WAVE w_image = root:internalUse:panelcommon:w_image	Duplicate/o n_EDC n_Ffit n_Ffit_x	n_Ffit_x = x		RemoveFromGraph/Z n_Ffit_x	AppendToGraph/Q/L=edc_en/B=edc_int n_Ffit_x vs n_Ffit		// hold-string	String cb, holdstr = ""	Variable index = 0	do		cb = "fer_c_"+ num2str(index)	// name of the checkbox		ControlInfo $cb		holdstr+= num2str(v_value)	index += 1	while(index <= 6)		index = 0	// fit the current EDC		///////////to designate fitting range with cursor A and B, added by Y He 20150407/////////////////////	Variable lowE, highE	lowE = (!numtype(pcsr(A)))?pcsr(A):0	highE = (!numtype(pcsr(B)))?pcsr(B):(numpnts(n_EDC)-1)			if(lowE > highE)		lowE += highE		highE = lowE - highE		lowE = lowE - highE	endif	////////////////////////////////			if (stringmatch(ctrlName,"fer_bfitOne"))			FermiGauss_init(n_EDC,FF_pw[6],1e-4)	// 0.1 meV step size			//	FuncFit /Q/H = holdstr FermiGauss  FF_pw n_EDC/D = n_Ffit		Duplicate/o FF_pw FF_epsilon		// added 10-05-04 to improve convergence (without much understanding...)		FF_epsilon=1e-5		FuncFit/N/Q/H = holdstr gold#FermiGauss  FF_pw n_EDC[lowE,highE]/E=FF_epsilon/D = n_Ffit				fp0 = FF_pw[0]; fp1 = FF_pw[1]; fp2 = FF_pw[2]; fp3 = FF_pw[3]; fp4 = FF_pw[4]; fp5 = FF_pw[5]; fp6 = FF_pw[6]			// fit all EDC's	elseif (stringmatch(ctrlName,"fer_bfitAll"))			Checkbox n_check3, value = 0		make_w_disp(w_image)		WAVE w_dispersion		WAVE w_resolution				Duplicate/o FF_pw FF_epsilon	// added 10-05-04 to improve convergence		FF_epsilon=1e-5					w_dispersion = fp4		w_resolution = fp6		for (index = 0; index < dimsize(w_image,0); index += 1)			Variable V_fitOptions = 4	// suppress progress window in FuncFit. See Curve Fitting.ihf			n_edc = w_image[index][p]			FermiGauss_init(n_EDC,FF_pw[6],4e-4)	// 1 meV step size!! // changed to 0.4 meV step size 07-01-04			//FuncFit /N/Q/H = holdstr FermiGauss  FF_pw n_EDC/D = n_Ffit			FuncFit /Q/N/H = holdstr gold#FermiGauss  FF_pw n_EDC[lowE,highE]/E=FF_epsilon/D = n_Ffit			fp0 = FF_pw[0]; fp1 = FF_pw[1]; fp2 = FF_pw[2]; fp3 = FF_pw[3]; fp4 = FF_pw[4]; fp5 = FF_pw[5]; fp6 = FF_pw[6]			w_dispersion[index] = fp4			w_resolution[index] = fp6			DoUpdate			if (utils_progressDlg(message = "fitting gold",numDone = index, numTotal = dimsize(w_image,0)))				break			endif		endfor	endif	utils_progressDlg(done = 1)		SetdataFolder $DfEndStatic Function buttonResetDisp(ctrlName)	String ctrlName		WAVE w_disp_s = root:internalUse:norm:w_dispersion_s	WAVE w_disp = root:internalUse:norm:w_dispersion	w_disp_s = w_dispEndStatic Function buttonSmoothDisp(ctrlName)	String ctrlName		String Df = getdatafolder (1)	SetDataFolder root:internalUse:norm		WAVE w_dispersion	String list =  TraceNameList("gold_panel",";",1)	Variable check = ( WhichListItem("w_dispersion_s",list,";") != -1 )	if ( check )	// w_dispersion_s is already on the graph		String notestr = note(w_dispersion)		Note/K w_dispersion_s		Note w_dispersion_s, notestr		Smooth 5, w_dispersion_s	else		Duplicate/o w_dispersion w_dispersion_s		Smooth 5, w_dispersion_s		AppendToGraph w_dispersion_s		ModifyGraph rgb(w_dispersion_s)=(1,9611,39321)	endif		SetdataFolder $DfendStatic Function buttonSaveDisp(ctrlName)	String ctrlName		String DF = GetDataFolder (1)	String dispName, UdispName, finalDispName, Number, suffix		SVAR dispNameBase = root:internalUse:norm:gs_w_dispNameBase	if (stringmatch(ctrlName,"fer*"))		suffix = "_disp"	else		suffix = "_aTMF"	endif	dispName = dispNameBase+suffix		if(stringmatch(ctrlName,"fer_b_6") || stringmatch(ctrlName,"tmf_b13"))		WAVE w_disp_s = root:internalUse:norm:w_dispersion_s	else		WAVE w_disp_s = root:internalUse:norm:w_dispersion	endif		NewDataFolder/o/s root:carpets	NewDataFolder/o/s normalized	NewDataFolder/o/s NormWaves		UdispName = dispName	if (waveexists($dispName))		UdispName = uniqueName(dispName,1,0)		//Number = UdispName[strlen(UdispName)-1]		//finalDispName = dispNameBase+"_"+number+suffix				DoAlert 0, "A wave with the name '"+dispName+"' already existed in ':NormWaves'.\rGenerated the new wave: '"+UdispName+"'."	endif	Duplicate/o w_disp_s $UdispName	print "//- saved '"+UdispName+"' in: 'root:carpets:normalized:NormWaves'"	SetDataFolder $DF	End// Nik's buttonStatic Function buttonNiksPlotFit(ctrlName)	String ctrlName		String DF = GetDataFolder (1)		WAVE edc = root:internalUse:panelcommon:n_edc	WAVE Ffit = root:internalUse:norm:n_Ffit	WAVE w_image = root:internalUse:panelcommon:w_image	NVAR fp0 = root:internalUse:norm:gv_fp0	NVAR fp1 = root:internalUse:norm:gv_fp1	NVAR fp2 = root:internalUse:norm:gv_fp2	NVAR fp3 = root:internalUse:norm:gv_fp3	NVAR fp4 = root:internalUse:norm:gv_fp4	NVAR fp5 = root:internalUse:norm:gv_fp5	NVAR fp6 = root:internalUse:norm:gv_fp6		String imageName = StringByKey("WaveName", note(w_image), "=","\r")	String edcName, fitName, text		ControlInfo n_check3	if(v_value)		edcName = "e_"+imageName[2,strlen(imagename)-1]+"_all"	// collapsed EDC's	else		edcName = "e_"+imageName[2,strlen(imagename)-1]+"_"+num2str(pcsr(B))	// single EDC	endif	fitName = edcName + "_Ffit"		NewDataFolder/o/s root:DCs	NewDataFolder/o/s Fermi	Duplicate/o edc $edcName	Duplicate/o Ffit $fitName		Display $edcName, $fitName	ModifyGraph lsize=0.6,rgb($edcName)=(0,0,0)	Label left "Intensity (kcts/s/channel)"	Label bottom "Energy (eV)"		Variable i0 = fp2 + fp3*fp4	Variable b0 = fp0 + fp1*fp4	text = "Intensity @ EF="+num2str(i0)+"\r"	text += "Background @ EF = "+num2str(b0)+"\r"	text += "Fermi-Level="+num2str(fp4)+"(eV)\r"	text += "Temperature="+num2str(fp5)+"(K)\r"	text += "Resolution="+num2str(fp6*1000)+"(meV)"	TextBox/C/N=text0/A=LB text		print "//- saved the waves: '"+edcName+"', '"+fitName+"' in the folder: 'root:DCs:Fermi:'" 	SetDataFolder $DFEnd////////////////////////////////////////// Private functions// N.B.: the keyword "Static" in front of "Procedure" limits visibility to the containing Igor Procedure File only.////////////////////////////////////////// NOTE: this is vintage code. It will be replaced eventually.// This function is called from i_panelcommon, namely from panelcommon_srcListboxProc().// The function name is auto-generated; it needs to be composed out of// <windowname>_SLB_proc such that panelcommon_srcListboxProc()// can find it. This function updates the graph view.// executed whenever one or more cells in the source list-boxes are selectedFunction gold_panel_SLB_proc()		String pDF = GetDataFolder (1)	SetDataFolder root:internalUse:panelcommon	SVAR DF = root:internalUse:panelcommon:gs_currentDF	SVAR pList = root:internalUse:panelcommon:gs_sourcePathList	SVAR topPath = root:internalUse:panelcommon:gs_TopItemPath			//WAVE w_sourceNamesSel	if (strlen(pList) == 0)		Make/o/n=(10,10) w_image=nan	else		Duplicate/o $topPath w_image	endif	Make/N=(dimsize(w_image,0))/O n_mdc, n_mdc2	Make/N=(dimsize(w_image,1))/O n_edc, n_edc2, n_edc_x	SetScale/I x, utils_x0(w_image),utils_x1(w_image), n_mdc, n_mdc2	SetScale/I x, utils_y0(w_image),utils_y1(w_image), n_edc, n_edc2, n_edc_x	n_edc_x = x				Variable xPoint = pcsr(B,"gold_panel")	Variable yPoint = qcsr(B,"gold_panel")	n_mdc = w_image[p][yPoint]	n_edc = w_image[xPoint][p]			gold_panel_defaults(w_image)	// This is needed to call the CursorMovedHook() function to update the	// image info if the image changes:	Cursor/I B, w_image, utils_pnt2x(w_image, xPoint), utils_pnt2y(w_image, yPoint)	//update_crop_limits(w_image)	SetDataFolder $pDFEnd// set the panel-globals to default values for the present waveStatic Function gold_panel_defaults(w)	WAVE w	// suppress update?	ControlInfo n_check0	if(v_value)		return -1	endif		String notestr = note(w)		String DF = GetDataFolder (1)	SetDataFolder root:internalUse:norm		// name for the dispersion wave	SVAR w_dispNameBase = gs_w_dispNameBase	w_dispNameBase = StringByKey("WaveName", notestr,"=","\r")				SetDataFolder $DFEnd		Static Function make_w_disp(w_image)	WAVE w_image	String Df = getdatafolder (1)	SetDataFolder root:internalUse:norm		Make/o/n=(dimsize(w_image,0)) w_dispersion, w_resolution	//, w_tmf	Variable ch0 = utils_getScientaChannel(w_image,0)	Variable ch1 = utils_getScientaChannel(w_image,1)	SetScale/I x ch0, ch1, w_dispersion, w_resolution	//, w_tmf		String notestr = note(w_image)	String imagefile = StringByKey("FileName", notestr, "=", "\r")	String wName = StringByKey("WaveName", notestr,"=","\r")	SVAR path = root:internalUse:panelcommon:gs_TopItemPath	Note w_dispersion, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels"	Note w_resolution, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels"	//Note w_tmf, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels"			SetdataFolder $DfEnd// generate the waves for the convolution// yw is a waveform// fwhm the initial guess for the Gaussian full width in units of the wave form (fitted width should be less than 2 times larger than initial guess!!)// dx the step size of the Gaussian in units of the waveformStatic Function FermiGauss_init(yw,fwhm,dx)	WAVE yw; Variable fwhm, dx		String Df = getdatafolder (1)	SetDataFolder root:internalUse:norm	Variable xmin =  pnt2x(yw,0)	Variable xmax = pnt2x(yw,numpnts(yw)-1)	Variable xrange = xmax - xmin	Variable from = round( (xmin - xrange/2)/dx) * dx	Variable to = round( (xmax + xrange/2)/dx) * dx		Variable fpoints = abs(to-from)/dx +1	// point number for the Fermi waves	Make/D/O/N=(fpoints) w_FermiF	SetScale/I x from,to, w_FermiF	Duplicate/o w_FermiF w_FermiG w_InternalXValues	w_InternalXValues=x	// x-wave for w_FermiG		Variable gpoints	 = abs( (6*fwhm) / dx)    	// optimal point number for the Gaussian (±3 fwhm)	Make/D/O/N=(gpoints) w_Gaussian	SetScale/I x -(gpoints-1)/2*dx,(gpoints-1)/2*dx, w_Gaussian		Variable/G gv_Gaussian_dx = dx		// needed by the fitfunction		SetDataFolder $DFEndStatic Function FermiGauss(pw, yw, xw): Fitfunc        Wave pw, yw, xw	WAVE FermiF = root:internalUse:norm:w_FermiF	WAVE FermiG = root:internalUse:norm:w_FermiG	WAVE InternalXValues = root:internalUse:norm:w_InternalXValues	WAVE Gaussian = root:internalUse:norm:w_Gaussian	NVAR dx = root:internalUse:norm:gv_Gaussian_dx          	Variable kB=8.617385e-5 			//  in eV/K   	FermiF=pw[0]+pw[1]*x + (pw[2]+pw[3]*x)/(exp((x-pw[4]) / (kB*pw[5]))+1.0 )      	FermiG = FermiF   	Variable aux0= 4*ln(2)/pw[6]^2	Gaussian = exp(-x^2*aux0) / ( sqrt(pi/aux0) / dx )		// norm=dx                 	Convolve/A Gaussian FermiG                    	//yw =interp(xw,InternalXvalues,FermiG)     	yw = FermiG(xw[p])End
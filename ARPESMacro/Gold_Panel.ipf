#pragma rtGlobals=1		// Use modern global access method.#pragma version = 0.01#pragma ModuleName = Goldpanel/////////////////////////////////Global Panel Function ////////////////////////////////////////Function /DF init_gold_panel()  	 DFREF DF = GetDataFolderDFR()       	NewDataFolder/o root:gold   	NewDataFolder/o root:gold:NormWaves   	String DF_panel="root:internalUse:"+winname(0,65)   	NewDataFolder/O/S $DF_panel   	DFREF DFR_panel=$DF_panel  	String/G gs_w_dispNameBase=""	if (exists("dispersionbase"))	String/G dispersionbase	else	String/G dispersionbase="basename"	endif	Variable/G V_FitOptions=4	Variable/G gv_fp0, gv_fp1, gv_fp2, gv_fp3, gv_fp4, gv_fp5, gv_fp6 //fit par	Variable/G gv_goldEi	Variable/G gv_goldEf		//fitrage	Variable /G gv_ef_base //tmf	Variable /G gv_killflag=0	Variable /G gv_polynum=3		Make /o/t/n=(1,4) w_dispNames	Make /o/n=(1,4) w_dispNames_sel	Make /o/t/n=4 w_dispTitle={"Wavename","PhotnE","PassE","Estep"}	w_dispNames_sel[0][]=1	make /o/n=(15)/t Tabnamelist		String /G gs_meanvalue="0 eV"	String /G gs_deviation="0 meV"	Variable /G gv_createnum=1	Make /o/n=3 w_createnorm_sel	Make /o/t/n=3 w_createnorm	w_createnorm="1"	w_createnorm_sel=2		SetDatafolder DF	return DFR_panelEndFunction open_gold_panel(ctrlName)	String ctrlName    	DFREF DF = GetDataFolderDFR()    	Variable SC = ScreenSize(5)	//Variable SR = ScreenSize(3) * SC	//Variable ST = ScreenSize(2) * SC	//Variable SL = ScreenSize(1) * SC   	// Variable SB = ScreenSize(4) * SC    	Variable SR = Igorsize(3) 	Variable ST = Igorsize(2)	Variable SL = Igorsize(1)    	Variable SB = Igorsize(4)        	    	DFREF DFR_prefs=$DF_prefs    	NVAR panelscale=DFR_prefs:gv_panelscale    	NVAR macscale=DFR_prefs:gv_macscale    	Variable Width = 520*panelscale*macscale 	// panel size  	Variable height = 500*panelscale *macscale	Variable xOffset = (SR-SL)/2-width/2	Variable yOffset =  (SB-ST)/2-height/2		String panelnamelist=winlist("gold_panel_*",";","WIN:65")		if (stringmatch(ctrlname,"recreate_window")==0)		if (strlen(panelnamelist)==0)			string spwinname=UniqueName("gold_panel_", 9, 0)			Display /W=(xOffset, yOffset,xOffset+width,Height+yOffset) as spwinname			DoWindow/C $spwinname			Setwindow $spwinname hook(MyHook) = Mypanelhook		else			BringUP_Allthepanel(panelnamelist,1)			SetDataFolder DF 			return 1		endif				DFREF DFR_panel=init_gold_panel()//"root:internalUse:"+winname(0,65)		DFREF DFR_common=init_panelcommon()			else		BringUP_Allthepanel(panelnamelist,1)		DFREF DFR_panel=$("root:internalUse:"+winname(0,65))		DFREF DFR_common=$("root:internalUse:"+winname(0,65)+":panel_common")   		SetActiveSubwindow $winname(0,65)	endif			ControlBar 220*SC		Variable r=57000, g=57000, b=57000	// background color for the TabControl	ModifyGraph cbRGB=(54428,54428,54428)	ModifyGraph wbRGB=(65535,56581,45115),gbRGB=(65535,56581,45115)					SetDataFolder DFR_panel	String panelcommonPath=GetDatafolder(1,DFR_common)			// controls that do not depend on the tabs	listbox global_waves_list, pos={16*SC,45*SC}, size={110*SC,140*SC}, widths={200}, listwave=DFR_common:w_sourceNames, selwave=DFR_common:w_sourceNamesSel, frame=2,mode=9, proc=source_Listbox_proc	listbox global_prolist, pos={133*SC,45*SC}, size={90*SC,140*SC}, listwave=DFR_common:w_proclist,selwave=DFR_common:w_proclistsel, frame=2,mode=5,proc=proc_Listbox_proc,colorwave=DFR_common:proclist_color	Titlebox global_tb1,title="Image",pos={20*SC,30*SC},labelBack=(r,g,b),frame=0,variable=DFR_common:gs_currentDF	//Titlebox global_tb2,title="Proc",pos={135,30},labelBack=(r,g,b),frame=0	checkbox global_ck6,title="lock",pos={180*SC,30*SC},labelBack=(r,g,b),frame=0,proc=c_locklayerproc,variable=DFR_common:gv_autolayerflag	CheckBox global_ck0, pos={10*SC,200*SC}, title="suppress update"	CheckBox global_ck1, pos={120*SC,200*SC}, title="lock DCs scale", proc=lock_intensity	CheckBox global_ck5, pos={225*SC,200*SC}, title="lock Image scale", proc=lock_intensity	CheckBox global_ck2, pos={350*SC,200*SC}, title="collapse E", proc=collapse_proc	CheckBox global_ck3, pos={430*SC,200*SC}, title="collapse k", proc=collapse_proc	CheckBox global_ck4, pos={520*SC,200*SC}, title="between cursors", proc=collapse_proc	Button global_close_panel, pos={530*SC,4*SC},size={60*SC,18*SC},title="close", proc=close_gold_panel		//Button global_gold, size={40,20},pos={640,25}, title="gold", proc=open_gold_panel	Button global_main, size={40*SC,20*SC},pos={645*SC,25*SC}, title="main", proc= Open_main_Panel	Button global_map, size={40*SC,20*SC},pos={645*SC,55*SC}, title="map", proc= open_mapper_panel	Button global_BZ, size={40*SC,20*SC},pos={645*SC,85*SC}, title="BZ", proc=open_bz_panel	Button global_Anal, size={40*SC,20*SC},pos={645*SC,115*SC}, title="Anal", proc=Open_Analysis_Panel	Button global_Fit, size={40*SC,20*SC},pos={645*SC,145*SC}, title="Fit", proc=open_fit_panel      Button global_opdt,labelBack=(r,g,b),pos={645*SC,175*SC},size={40*SC,20*SC},title="DataT",proc=open_data_table    		// --------------------------tab-controls -----------------	// source tabselwave=DFR_common:w_DFListsel,    	TabControl gold, proc=GoldPanel#gold_AutoTab_Proc,pos={8*SC,6*SC},size={630*SC,190*SC},value=0,labelBack=(r,g,b)	    	GroupBox source_gb0, frame=0,labelBack=(r,g,b), pos={230*SC,30*SC}, size={295*SC,155*SC}, title="source folder"    	listbox source_lb1, pos={240*SC,70*SC}, size={270*SC,110*SC}, widths={400}, listwave=DFR_common:w_DF,selrow=0, frame=2,mode=6, proc=source_Listbox_proc    	SetVariable source_sv0,labelBack=(r,g,b), pos={240*SC,50*SC},size={130*SC,20*SC}, title="search",frame=1,value=DFR_common:gs_matchstring,proc=Folder_list_search_proc    	Button source_bt0,labelBack=(r,g,b),pos={370*SC,48*SC},size={45*SC,20*SC},title="All",proc=Default_Folder_proc    	Button source_bt1,labelBack=(r,g,b),pos={420*SC,48*SC},size={45*SC,20*SC},title="process",proc=Default_Folder_proc    	Button source_bt3,labelBack=(r,g,b),pos={470*SC,48*SC},size={45*SC,20*SC},title="gold",proc=Default_Folder_proc    	//checkbox source_ck1,labelBack=(r,g,b), pos={550,30},size={80,20}, title="2D", value=0,proc=c_dim    	//checkbox source_ck2,labelBack=(r,g,b), pos={590,30},size={80,20}, title="3D", value=1//,proc=c_dim   	checkbox source_ck0,labelBack=(r,g,b), pos={527*SC,50*SC},size={80*SC,20*SC}, title="sort", value=1,proc=wave_list_sort_proc    	Button source_robt,labelBack=(r,g,b),pos={572*SC,48*SC},size={60*SC,18*SC},title="reorder",proc=wave_reorder_proc   	Button source_autoload,labelBack=(r,g,b),pos={530*SC,75*SC},size={100*SC,25*SC},title="autoload",proc=wave_autoload_proc    	Button source_delwave,labelBack=(r,g,b),pos={530*SC,106*SC},size={80*SC,18*SC},title="Del waves",proc=wave_delfrompanel_proc    	Button source_bt4,labelBack=(r,g,b),pos={530*SC,126*SC},size={40*SC,18*SC},title="New",proc=main_wave_save_NewDF    	Button source_bt6,labelBack=(r,g,b),pos={570*SC,126*SC},size={30*SC,18*SC},title="Del",proc=main_wave_del_NewDF    	Button source_bt7,labelBack=(r,g,b),pos={600*SC,126*SC},size={30*SC,18*SC},title="Re",proc=main_wave_rename_NewDF   	//Button source_bt4,labelBack=(r,g,b),pos={530,104},size={100,18},fsize=12,title="To process",proc=main_wave_save_toprocess   	// Button source_bt4,labelBack=(r,g,b),pos={530*SC,124*SC},size={50*SC,18*SC},title="New DF",proc=main_wave_save_NewDF    	//Button source_bt6,labelBack=(r,g,b),pos={580*SC,124*SC},size={50*SC,18*SC},title="Del DF",proc=main_wave_del_NewDF    	popupmenu source_pop3,labelBack=(r,g,b),pos={530*SC,147*SC},bodywidth=100*SC,size={100*SC,18*SC},fsize=12,title="",value=#(panelcommonPath+"gs_DFlist")    	Button source_svbt0,labelBack=(r,g,b),pos={580*SC,170*SC},size={50*SC,18*SC},title="Move To",proc=main_wave_save_proc    	Button source_svbt1,labelBack=(r,g,b),pos={530*SC,170*SC},size={50*SC,18*SC},title="Copy To",proc=main_wave_save_proc  		     	add_Tab_gold_disp(DF_panel,DFR_common)	add_Tab_gold_TMF(DF_panel,DFR_common)	add_Tab_gold_NormList(DF_panel,DFR_common)	Wave /t tabnamelist		TabControl gold,tabLabel(0)="source"	tabnamelist[0]="source"	TabControl gold,tabLabel(1)="disp"	tabnamelist[1]="disp"	TabControl gold,tabLabel(2)="TMF"	tabnamelist[2]="TMF"	TabControl gold,tabLabel(3)="Normlist"	tabnamelist[3]="Normlist"		add_image_DCs("gold_panel")	panelimageupdate(3)	gold_panel_SLB_proc()	SetDataFolder DFEndFunction close_gold_panel(ctrlname)	String ctrlName	String wname=winName(0,65)	String DF_panel="root:internalUse:"+wname		DFREF DFR_panel=$DF_panel		NVAR killflag=DFR_panel:gv_killflag		killflag=1	dowindow/K $wname//	dowindow/K gold_panelEndFunction add_Tab_gold_disp(DF_panel,DFR_common)	DFREF DF_panel	DFREF DFR_common	DFREF DF=GetDatafolderDFR()	SetDatafolder DF_panel	// Fermi fit	//TabControl gold,tabLabel(tabindex)="disp"	Variable r=57000, g=57000, b=57000	Variable x4 = 230, y4 = 35	Variable SC=screensize(5)	SetVariable disp_sv_0,labelBack=(r,g,b), pos={230*SC,35*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="offset",frame=1,value= gv_fp0, disable=1	SetVariable disp_sv_1,labelBack=(r,g,b), pos={230*SC,53*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="offset-slope",frame=1,value= gv_fp1, disable=1	SetVariable disp_sv_2,labelBack=(r,g,b), pos={230*SC,71*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="dos",frame=1,value= gv_fp2, disable=1	SetVariable disp_sv_3,labelBack=(r,g,b), pos={230*SC,89*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="dos-slope",frame=1,value= gv_fp3, disable=1	SetVariable disp_sv_4,labelBack=(r,g,b), pos={230*SC,107*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="EF",frame=1,value= gv_fp4, disable=1	SetVariable disp_sv_5,labelBack=(r,g,b), pos={230*SC,125*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="Temp.",frame=1,value= gv_fp5, disable=1	SetVariable disp_sv_6,labelBack=(r,g,b), pos={230*SC,143*SC},size={115*SC,15*SC}, limits={-inf,inf,0}, title="resolution",frame=1,value= gv_fp6, disable=1	Button disp_b_0, pos={230*SC,162*SC},size={60*SC,15*SC}, labelback=(r,g,b),title="guess", disable=1, proc=Goldpanel#Fermi_guess	Button disp_b_13, pos={230*SC,177*SC},size={60*SC,15*SC}, labelback=(r,g,b),title="TMF", disable=1, proc=Goldpanel#Correct_TMF		///SetVariable disp_sv_7,labelBack=(r,g,b), pos={x4+65,y4+127},size={70,15}, limits={-inf,inf,0}, title="E_i",frame=1,fsize=10,value= gv_goldEi, disable=1	//SetVariable disp_sv_8,labelBack=(r,g,b), pos={x4+65,y4+142},size={70,15}, limits={-inf,inf,0}, title="E_f",frame=1,fsize=10,value= gv_goldEf, disable=1	SetVariable disp_sv_7,labelBack=(r,g,b), pos={295*SC,162*SC},size={70*SC,15*SC}, limits={-inf,inf,0}, title="E_i",frame=1,value= DFR_common:gv_E0, disable=1	SetVariable disp_sv_8,labelBack=(r,g,b), pos={295*SC,177*SC},size={70*SC,15*SC}, limits={-inf,inf,0}, title="E_f",frame=1,value= DFR_common:gv_E1, disable=1		CheckBox disp_c_0, pos={350*SC,35*SC}, title="",labelBack=(r,g,b), disable=1	CheckBox disp_c_1, pos={350*SC,53*SC}, title="",labelBack=(r,g,b), disable=1	CheckBox disp_c_2, pos={350*SC,71*SC}, title="",labelBack=(r,g,b), disable=1	CheckBox disp_c_3, pos={350*SC,89*SC}, title="",labelBack=(r,g,b), disable=1	CheckBox disp_c_4, pos={350*SC,107*SC}, title="",labelBack=(r,g,b), disable=1	CheckBox disp_c_5, pos={350*SC,125*SC}, title="",labelBack=(r,g,b), disable=1, value=1	CheckBox disp_c_6, pos={350*SC,143*SC}, title="",labelBack=(r,g,b), disable=1		GroupBox disp_gb1, frame=0,labelBack=(r,g,b), pos={370*SC,25*SC}, size={165*SC,87*SC}, title="fit", disable=1	Button disp_b_1, pos={380*SC,42*SC},size={45*SC,16*SC}, labelback=(r,g,b),title="one", disable=1, proc=Goldpanel#FF_one_or_all	Button disp_b_2, pos={430*SC,42*SC},size={45*SC,16*SC}, labelback=(r,g,b),title="all", disable=1, proc =Goldpanel#FF_one_or_all	Button disp_b_3, pos={480*SC,42*SC},size={45*SC,16*SC}, labelback=(r,g,b),title="Plot", disable=1, proc = Goldpanel#plot_fit	CheckBox disp_c_10, pos={380*SC,59*SC}, size={85*SC,16*SC},title="show dispersion wave",labelBack=(r,g,b), disable=1, proc = Goldpanel#FF_show_disp	CheckBox disp_c_11, pos={380*SC,75*SC}, size={85*SC,16*SC},title="show resolution",labelBack=(r,g,b), disable=1, proc =Goldpanel#FF_show_disp	Button disp_b_15, pos={480*SC,75*SC},size={45*SC,16*SC}, labelback=(r,g,b),title="Hist", disable=1, proc = Goldpanel#plot_Hist			GroupBox disp_gb2, frame=0,labelBack=(r,g,b), pos={370*SC,113*SC}, size={260*SC,75*SC}, title="dispersion wave", disable=1	Button disp_b_5, pos={550*SC,130*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="reset", disable=1, proc=Goldpanel#reset_dispersion	Button disp_b_6, pos={550*SC,148*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="save", disable=1, proc=Goldpanel#save_dispersion	Button disp_b_7, pos={550*SC,167*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="save raw", disable=1, proc=Goldpanel#save_dispersion	SetVariable disp_sv_10,labelBack=(r,g,b), pos={375*SC,167*SC},size={155*SC,15*SC}, title="name base:",frame=1,value= gs_w_dispNameBase, disable=1		Button disp_b_4, pos={375*SC,150*SC},size={80*SC,15*SC}, labelback=(r,g,b),title="smooth", disable=1, proc=Goldpanel#smooth_dispersion	Button disp_b_8, pos={375*SC,130*SC},size={80*SC,15*SC},labelback=(r,g,b),title="fit Linear", disable=1, proc=Goldpanel#fitdisp	Button disp_b_9, pos={460*SC,130*SC},size={80*SC,15*SC},labelback=(r,g,b),title="fit Parabola", disable=1, proc=Goldpanel#fitdisp	SetVariable disp_sv_11,labelBack=(r,g,b), pos={460*SC,150*SC},size={80*SC,15*SC}, title="poly:",frame=1,limits={3,20,1},variable=DF_panel:gv_polynum, disable=1			GroupBox disp_gb3, frame=0,labelBack=(r,g,b), pos={540*SC,25*SC}, size={90*SC,87*SC}, title="copy disp", disable=1	SVAR dispersionBase	TitleBox disp_t0, pos={555*SC,40*SC}, size={80*SC,12*SC}, frame=0,title=dispersionBase, disable=1	Button disp_b_10, pos={550*SC,57*SC},size={70*SC,15*SC},labelback=(r,g,b),title="SetBase", disable=1, proc=Goldpanel#Setbasedisp	Button disp_b_11, pos={550*SC,74*SC},size={70*SC,15*SC},labelback=(r,g,b),title="CopyNew", disable=1, proc=Goldpanel#Copynewdisp	Button disp_b_12, pos={550*SC,93*SC},size={70*SC,15*SC},labelback=(r,g,b),title="Loaddisp", disable=1, proc=Goldpanel#Loadbasedisp		SetDatafolder DFEnd	Function add_Tab_gold_TMF(DF_panel,DFR_common)	DFREF DF_panel	DFREF DFR_common	DFREF DF=GetDatafolderDFR()	SetDatafolder DF_panel	//TabControl gold,tabLabel(tabindex)="TMF"	Variable r=57000, g=57000, b=57000		Variable SC=Screensize(5)	GroupBox tmf_gb1, frame=0,pos={230*SC,35*SC}, size={122*SC,115*SC}, title="integration range", disable=1	SetVariable tmf_sv0,labelBack=(r,g,b), pos={240*SC,55*SC},size={90*SC,15*SC}, limits={-inf,inf,0}, title="E_0:",frame=1,value= DFR_common:gv_E0, disable=1,proc=Goldpanel#Proc_tmf_energychange	SetVariable tmf_sv1,labelBack=(r,g,b), pos={240*SC,75*SC},size={90*SC,15*SC}, limits={-inf,inf,0}, title="E_1:",frame=1,value= DFR_common:gv_E1, disable=1,proc=Goldpanel#Proc_tmf_energychange	//Button tmf_b4, pos={240,100}, size={30,14}, labelback=(r,g,b), title="m", proc=read_marquee, disable=1	Button tmf_b5, pos={235*SC,120*SC}, size={50*SC,18*SC}, labelback=(r,g,b), title="low", proc=Goldpanel#default_E0E1_gold, disable=1	Button tmf_b6, pos={290*SC,120*SC}, size={50*SC,18*SC}, labelback=(r,g,b), title="high", proc=Goldpanel#default_E0E1_gold, disable=1	TitleBox tmf_t4, pos={270*SC,101*SC}, size={80*SC,12*SC}, frame=0,title="default", disable=1	//TitleBox tmf_t5, pos={275,121}, size={80,12}, frame=0,title="default low", disable=1	//TitleBox tmf_t6, pos={275,141}, size={80,12}, frame=0,title="default high", disable=1		GroupBox tmf_gb10, frame=0,labelBack=(r,g,b), pos={368*SC,35*SC}, size={100*SC,125*SC}, title="generate/save TMF", disable=1	CheckBox tmf_c10, pos={378*SC,60*SC}, title="show wave",labelBack=(r,g,b), proc=Goldpanel#show_TMF, disable=1	//Button tmf_b10, pos={378,80},size={70,15}, labelback=(r,g,b),title="integrate", disable=1, proc=new_TMF	Button tmf_b11, pos={378*SC,60*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="smooth", disable=1, proc=Goldpanel#smooth_dispersion	Button tmf_b12, pos={378*SC,100*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="reset", disable=1, proc=Goldpanel#reset_dispersion	Button tmf_b13, pos={378*SC,120*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="save", disable=1, proc=Goldpanel#save_tmf	Button tmf_b14, pos={378*SC,140*SC},size={70*SC,15*SC}, labelback=(r,g,b),title="save raw", disable=1, proc=Goldpanel#save_tmf	SetVariable tmf_sv10,labelBack=(r,g,b), pos={378*SC,170*SC},size={150*SC,15*SC}, title="name base:",frame=1,value= gs_w_dispNameBase, disable=1		SetDatafolder DFEndFunction add_Tab_gold_NormList(DF_panel,DFR_common)	DFREF DF_panel	DFREF DFR_common	DFREF DF=GetDatafolderDFR()	SetDatafolder DF_panel	// Fermi fit	//TabControl gold,tabLabel(tabindex)="disp"	Variable r=57000, g=57000, b=57000	Wave /T w_dispNames=DF_panel:w_dispNames	Wave w_dispNames_sel=DF_panel:w_dispNames_sel	Wave /T  w_dispTitle=DF_panel:w_dispTitle	SVAR gs_meanvalue=DF_panel:gs_meanvalue	SVAR gs_deviation=DF_panel:gs_deviation	NVAR gv_createnum=DF_panel:gv_createnum		Variable SC=ScreenSize(5)		GroupBox NormList_gb0, frame=0,pos={30*SC,35*SC}, size={200*SC,140*SC}, title="Norm wave",  disable=1	listbox NormList_lb1, pos={40*SC,55*SC}, size={180*SC,105*SC}, widths={120,60,40},listwave=DF_panel:w_dispNames,selrow=0,selwave=DF_panel:w_dispNames_sel,frame=2,mode=9, titleWave=DF_panel:w_dispTitle,disable=1, proc=Goldpanel#Proc_listbox_goldNormNames		checkbox NormList_ck0, pos={240*SC,35*SC},size={100*SC,80*SC},title="Dispersion",value=1,disable=1,proc=Goldpanel#Proc_checkbox_normwavesel	checkbox NormList_ck1, pos={330*SC,35*SC},size={100*SC,80*SC},title="TMF",value=0,disable=1,proc=Goldpanel#Proc_checkbox_normwavesel	titlebox NormList_tb0, Pos={240*SC,62*SC},size={100*SC,30*SC},title="Mean Value:",disable=1,frame=0	titlebox NormList_tb1, Pos={320*SC,60*SC},size={100*SC,30*SC},title="Mean Value:", variable=gs_meanvalue,disable=1,fstyle=1,frame=0	titlebox NormList_tb2,Pos={240*SC,87*SC},size={100*SC,30*SC},title="Deviation:",disable=1,frame=0	titlebox NormList_tb3, Pos={320*SC,85*SC},size={100*SC,30*SC},title="Deviation:", variable=gs_deviation,disable=1,fstyle=1,frame=0	Button NormList_b0,Pos={240*SC,115*SC},size={60*SC,20*SC},title="Del",disable=1,Proc=Goldpanel#Proc_button_delnormwave	Button NormList_b3,Pos={240*SC,140*SC},size={60*SC,20*SC},title="ToDisp",disable=1,Proc=Goldpanel#Proc_button_copynormwave	//Button NormList_b4,Pos={240,165},size={60,20},title="ToTMF",disable=1,Proc=Proc_button_copynormwave	Button Normlist_b1,Pos={310*SC,115*SC},size={100*SC,20*SC},title="Set Mean Value",disable=1,Proc=Goldpanel#Proc_button_Setnormwave	Button Normlist_b2,Pos={310*SC,140*SC},size={100*SC,20*SC},title="Shift Value",disable=1,Proc=Goldpanel#Proc_button_shiftnormwave	Button Normlist_b5,Pos={310*SC,165*SC},size={100*SC,20*SC},title="EF vs Time",disable=1,Proc=Goldpanel#Proc_button_dispEFvsTime		groupbox NormList_gb1,frame=0,pos={430*SC,35*SC}, size={200*SC,140*SC}, title="Interp disp waves", disable=1, disable=1	listbox NormList_lb2, pos={440*SC,55*SC}, size={80*SC,105*SC}, disable=1,listwave=DF_panel:w_createnorm,selrow=0,selwave=DF_panel:w_createnorm_sel,frame=2,mode=9, disable=1//, proc=Proc_listbox_goldNormNames	Setvariable Normlist_sv0,pos={540*SC,55*SC},size={80*SC,20*SC},disable=1,title="Num:",value=gv_createnum,proc=Goldpanel#Proc_Setvariable_Setcreatenum,limits={1,inf,1}	Button Normlist_b4,Pos={540*SC,110*SC},size={80*SC,20*SC},title="Linear Create",disable=1,Proc=Goldpanel#Proc_button_createnormwave	Button Normlist_b10,Pos={540*SC,135*SC},size={80*SC,20*SC},title="Fit Create",disable=1,Proc=Goldpanel#Proc_button_Fitcreatenormwave		Button Normlist_b6,Pos={540*SC,85*SC},size={80*SC,20*SC},title="Guess",disable=1,Proc=Goldpanel#Proc_button_Guessnormwave		//w_createnorm,w_createnorm_sel			SetDatafolder DFEnd	/////////////////////////////////Global Function ////////////////////////////////////////// executed whenever one or more cells in the source list-boxes are selectedFunction gold_panel_SLB_proc()		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	SetDataFolder $DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)		Wave w=DFR_common:w_image		// suppress update?	ControlInfo global_ck0	if(v_value)		return -1	endif		String notestr = note(w)	// name for the dispersion wave	SVAR w_dispNameBase = gs_w_dispNameBase	w_dispNameBase = StringByKey("WaveName", notestr,"=","\r")		controlinfo gold			strswitch(S_Value)	case "disp":		controlinfo disp_c_10	    if (v_value==0)	    CheckBox disp_c_10, value=1		endif		FF_show_disp("disp_c_10",1)		checkbox tmf_c10, disable=1, value=0	break	case "TMF":		controlinfo tmf_c10		if (v_value==0)		checkbox tmf_c10, disable=1, value=1		endif		show_TMF("dummy",1)		CheckBox disp_c_10, value=0		CheckBox disp_c_11, value=0	break	endswitch		SetDataFolder DFEnd/////////////////////////////////static Function ////////////////////////////////////////static Function gold_AutoTab_Proc( name, tab )	String name	Variable tab	SetActivesubwindow $winname(0,65)	// Get the name of the current tab	ControlInfo $name	String tabStr = S_Value	String curTabMatch= tabstr+"_*"    String name_panel=winname(0,65)	String controlsInATab= ControlNameList(name_panel,";","*_*")	String controlsInCurTab= ListMatch(controlsInATab, curTabMatch)	String controlsglobalcontrols=ListMatch(controlsInATab, "*global*")	String controlsInOtherTabs= ListMatch(controlsInATab, "!"+curTabMatch)	ModifyControlList controlsInOtherTabs disable=1	// hide	ModifyControlList controlsInCurTab disable=0		// show	ModifyControlList controlsglobalcontrols disable=0				String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_common= $(DF_panel+":panel_common")	DFREF DFR_panel=$DF_panel	WAVE n_edc2 = DFR_common:n_edc2	WAVE n_mdc = DFR_common:n_mdc				// tab-specific adjustments	if ( stringmatch(tabStr,"source")==1)	// not on the Fermi-tab -> switch back to mdc-display		AppendToGraph n_edc2	// first append a dummy to avoid having no wave on the graph		RemoveFromGraph/Z n_Ffit_x, n_mdc, w_dispersion		RemoveFromGraph/Z w_dispersion_s, w_resolution,w_norm,w_norm_s		DeleteBasednamegraph(winname(0,65),"*_disp*",1)		DeleteBasednamegraph(winname(0,65),"*_atmf*",1)		AppendToGraph n_mdc		ModifyGraph rgb(n_mdc)=(1,26214,0)		//ModifyGraph rgb(n_mdc)=(1,16019,65535)		RemoveFromGraph/Z  n_edc2		CheckBox disp_c_10, value=0		CheckBox disp_c_11, value=0		checkbox tmf_c10, disable=1, value=0	endif		if ( stringmatch(tabStr,"disp")==1)	    controlinfo disp_c_10	    if (v_value==0)	    		CheckBox disp_c_10, value=1			FF_show_disp("disp_c_10",1)		endif		checkbox tmf_c10, disable=1, value=0	endif		if ( stringmatch(tabStr,"tmf")==1)	// not on the Fermi-tab -> switch back to mdc-display		controlinfo tmf_c10		if (v_value==0)			checkbox tmf_c10, disable=1, value=1			show_TMF("dummy",1)		else			checkbox tmf_c10, disable=1		endif		CheckBox disp_c_10, value=0		CheckBox disp_c_11, value=0	endif		if ( stringmatch(tabStr,"Normlist")==1)	Listbox global_waves_list,disable=1	Listbox global_prolist,disable=1	checkbox global_ck6,disable=1	titlebox global_tb1,disable=1		   gold_updatenormwave_List()	   Wave /T w_dispNames=DFR_panel:w_dispNames	   Wave w_dispnames_sel=DFR_panel:w_dispNames_sel	   show_Multi_Normwave(w_dispNames,w_dispnames_sel)	 	CheckBox disp_c_10, value=0		CheckBox disp_c_11, value=0		checkbox tmf_c10, disable=1, value=0	EndifEndstatic Function FF_show_disp(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	DFREF DF = GetDataFolderDFR()	SetActivesubwindow $winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")		String wname=winname(0,65)		SetDatafolder DFR_panel		WAVE w_image = DFR_common:w_image	WAVE n_mdc = DFR_common:n_mdc	WAVE n_edc2 = DFR_common:n_edc2		NVAR fp4 = gv_fp4	NVAR fp6 = gv_fp6	WAVE w_dispersion	WAVE w_resolution				Variable checkvalue=0		Strswitch(ctrlname)	case "disp_c_10":	checkvalue=0	if (checked)		if (!waveexists(w_dispersion))			//	Fermi_guess("dummy")				make_w_disp(w_image)				WAVE w_dispersion				w_dispersion = fp4					WAVE w_dispersion_s				W_dispersion_s=w_dispersion		else			WAVE w_dispersion			if (numpnts(w_dispersion)!=dimsize(w_image,0))				Wave w_dispersion_s				duplicate /o w_dispersion_s w_dispersion_Temp				make_w_disp(w_image)				Wave w_dispersion				w_dispersion=w_dispersion_Temp(x)				WAVE w_dispersion_s				w_dispersion_s=w_dispersion				//WAVE w_dispersion				//w_dispersion = fp4					//WAVE w_dispersion_s				//W_dispersion_s=w_dispersion			endif			endif		WAVE w_dispersion, w_dispersion_s		 	AppendToGraph n_edc2		 	RemoveFromGraph/Z n_mdc, w_resolution,w_norm,w_norm_s,w_dispersion,w_dispersion_s			DeleteBasednamegraph(winname(0,65),"*_disp*",1)			DeleteBasednamegraph(winname(0,65),"*_atmf*",1)			AppendToGraph w_dispersion,w_dispersion_s			ModifyGraph mode(w_dispersion)=3,marker(w_dispersion)=19,msize(w_dispersion)=1			ModifyGraph rgb(w_dispersion_s)=(0,0,52224)			RemoveFromGraph/Z n_edc2				endif					//RemoveFromGraph/Z n_mdc, w_resolution, w_norm	break	case "disp_c_11":	checkvalue=1	if (checked)		if (!waveexists(w_resolution))			//	_guess("dummy")			make_w_disp(w_image)			WAVE w_resolution			w_resolution = fp6		else			WAVE w_resolution			if (numpnts(w_resolution)!=dimsize(w_image,0))				make_w_disp(w_image)				WAVE w_resolution				w_resolution = fp6			endif		endif			WAVE w_resolution									AppendToGraph n_edc2			RemoveFromGraph/Z n_mdc, w_dispersion, w_dispersion_s,w_norm,w_norm_s,w_resolution			DeleteBasednamegraph(winname(0,65),"*_disp*",1)			DeleteBasednamegraph(winname(0,65),"*_atmf*",1)			AppendToGraph w_resolution			ModifyGraph mode(w_resolution)=3,marker(w_resolution)=19,msize(w_resolution)=1			RemoveFromGraph/Z n_edc2							endif	break	Endswitch		checkbox disp_c_10,win=$wname,value=checkvalue==0	checkbox disp_c_11,win=$wname,value=checkvalue==1		SetDataFolder DFEndstatic Function /s save_dispersion(ctrlName)	String ctrlName		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		SVAR dispNameBase = gs_w_dispNameBase		Wave waveVars=DFR_common:WaveVars	SVAR Topimage=DFR_common:gs_TopItemPath	 	String dispName, UdispName, finalDispName, Number, suffix			//String photonenergy=num2str(waveVars[6])	suffix = "_disp"		//if (strlen(photonenergy)>0)	//   suffix+=photonenergy+"eV"	//   suffix=replacestring(".",suffix,"_")	//endif	dispName = dispNameBase+suffix		if (stringmatch(ctrlname,"disp_b_6"))	WAVE w_disp = DFR_panel:w_dispersion_s	else	WAVE w_disp = DFR_panel:w_dispersion	endif			String savepath="root:gold:NormWaves:"	SetDatafolder $savepath		UdispName = dispName	if (waveexists($dispName))			DoAlert 1, "A wave with the name '"+dispName+"' already existed in ':NormWaves'.\r Yes: Overwrite, No: Generated the new wave?"		if (v_flag==1)		else		UdispName = uniqueName(dispName,1,0)		endif	endif		Duplicate/o w_disp $(savepath+UdispName)	Wave savedisp=$(savepath+UdispName)		Wave w_image=DFR_common:w_image	String notestr = NewDispwave_note(w_image)	notestr=replacenumberbykey("FermiEnergy",notestr,mean(w_disp),"=","\r")		Note /K savedisp	note savedisp,notestr	//wave_save_proc((Topimage+";"),root:gold,0)	print "//- saved '"+UdispName+"' in: 'root:gold:NormWaves'"		SetDataFolder DF	return savepath+UdispNameEndstatic Function /S newDispwave_note(w_image)	Wave w_image		String notestr=note(w_image)	String imagefile = StringByKey("FileName", notestr, "=", "\r")	String wName = StringByKey("WaveName", notestr,"=","\r")	String passE=StringbyKey("PassEnergy",notestr,"=","\r")	Variable  E_step=Numberbykey("Energy Step",notestr,"=","\r")	Variable PhotonE=Numberbykey("PhotonEnergy",notestr,"=","\r")		String reNotestr	reNotestr="SourceFileName="+imagefile+"\r"	reNotestr+="SourceWave="+wName+"\r"	reNotestr+="Scaling=channels\r"	reNotestr+="FermiEnergy=\r"	reNoteStr+="PhotonEnergy="+num2str(PhotonE)+"eV\r"	reNotestr+="PassEnergy="+PassE+"eV\r"	reNotestr+="EnergyStep="+num2str(E_step*1000)+"meV\r"			return renotestrendstatic Function readDispwave_note(w_disp)	Wave w_disp		Make /o/t/n=7 w_ReadingResult		String notestr=note(w_disp)		w_ReadingResult[0]=StringByKey("SourceFileName", notestr, "=", "\r")	w_ReadingResult[1]=StringByKey("SourceWave", notestr, "=", "\r")	w_ReadingResult[2]=StringByKey("Scaling", notestr, "=", "\r")	w_ReadingResult[3]=StringByKey("FermiEnergy", notestr, "=", "\r")	w_ReadingResult[4]=StringByKey("PhotonEnergy", notestr, "=", "\r")	w_ReadingResult[5]=StringByKey("PassEnergy", notestr, "=", "\r")	w_ReadingResult[6]=StringByKey("EnergyStep", notestr, "=", "\r")endstatic Function make_w_disp(w_image)	WAVE w_image	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		Wave w_image=DFR_common:w_image	SVAR path = DFR_common:gs_TopItemPath		Make/o/n=(dimsize(w_image,0)) w_dispersion, w_resolution,w_dispersion_s	//, w_tmf	Variable ch0 = Scienta_ch(w_image,0)	Variable ch1 = Scienta_ch(w_image,1)	SetScale/I x ch0, ch1, w_dispersion, w_dispersion_s,w_resolution	//, w_tmf		//Note w_tmf, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels"			SetdataFolder DfEndstatic Function reset_dispersion(ctrlName)	String ctrlName	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel			if (stringmatch(ctrlname,"tmf_b12"))		WAVE w_norm_s	WAVE w_norm	w_norm_s = w_norm	else	WAVE w_dispersion_s	WAVE w_dispersion	w_dispersion_s = w_dispersion	endif		SetdataFolder DfEndstatic Function smooth_dispersion(ctrlName)	String ctrlName		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		if (stringmatch(ctrlname,"tmf_b11"))	WAVE w_norm_s	Smooth 5, w_norm_s	else	WAVE w_dispersion_s	Smooth 5, w_dispersion_s	endif			SetdataFolder Dfendstatic Function fitdisp(ctrlName)   String ctrlName   DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel	   	WAVE w_dispersion   	Wave w_dispersion_s   	NVAR gv_polynum=DFR_panel:gv_polynum  // String list =  TraceNameList("gold_panel",";",1)   //Variable check = string_List_check("w_dispersion_s",list,";")	//if ( check )			//endif		//String notestr = note(w_dispersion)	//Duplicate/o w_dispersion w_dispersion_s	//Wave w_dispersion_s	//Note/K w_dispersion_s	//Note w_dispersion_s, notestr		if (stringmatch(ctrlName,"disp_b_8"))		CurveFit /N/Q line, w_dispersion /D=w_dispersion_s	endif	if (stringmatch(ctrlName,"disp_b_9"))	    CurveFit /N/Q poly gv_polynum, w_dispersion /D=w_dispersion_s	endif	removefromgraph /Z w_dispersion_s	AppendToGraph w_dispersion_s	ModifyGraph rgb(w_dispersion_s)=(1,9611,39321)	SetDatafolder DFendstatic Function Setbasedisp(ctrlName)   String ctrlName  DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel	   SVAR dispNameBase = gs_w_dispNameBase   SVAR dispersionbase   NVAR w_ef=gv_fp4   NVAR efbase=gv_ef_base   efbase=w_ef   dispersionbase = dispNameBase   TitleBox disp_t0,title=dispersionBase      String Savepath=save_dispersion("disp_b_6")       Wave w_dispersion=$Savepath  	String notestr	//String efstring	//Wave w_dispersion_s	duplicate /o w_dispersion, Base_dispersion		notestr=note(w_dispersion)	notestr+="BaseFermiEnergy=\r"	notestr=replacenumberbykey("BaseFermiEnergy",notestr,w_ef,"=","\r")	note /K Base_dispersion	note /K w_dispersion	note Base_dispersion, notestr	note w_dispersion, notestr	//copynewdisp("disp")   SetDatafolder DFEndstatic Function Loadbasedisp(ctrlName)   String ctrlname   DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel	   SVAR dispersionbase   NVAR efbase=gv_ef_base   String cmd = "CreateBrowser prompt=\"select the dispersion wave and click 'ok'\""	execute cmd	SVAR S_BrowserList=S_BrowserList		NVAR flag=V_Flag		if(flag==0)			return -1		endif	String path		path = StringFromList(0,s_browserList)	Wave w_disp=$path	String notestr=note(w_disp)	Variable baseef=NumberByKey("BaseFermiEnergy",notestr,"=","\r")	if (numtype(baseef)==2)	DoAlert 0, "Not a valid dispersion curve"	return 1	else	efbase=baseef	endif	duplicate /o w_disp, base_dispersion		String basename1=StringBykey("SourceWave",notestr,"=","\r")    String basename2=basename1[(strsearch(basename1,":",inf,1)+1),inf]    dispersionbase=basename2    TitleBox disp_t0,title=dispersionBase    SetDatafolder DfEndStatic Function Copynewdisp(ctrlName)   String ctrlName   DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel	   SVAR dispNameBase=gs_w_dispNameBase   SVAR dispersionbase   NVAR efbase=gv_ef_base   NVAR w_ef=gv_fp4   WAVE basedispersion=Base_dispersion         String dispName, UdispName, finalDispName, Number, suffix   SVAR Topimage=DFR_common:gs_TopItemPath   Wave waveVars=DFR_common:WaveVars  // String photonenergy=num2str(waveVars[6])		suffix = "_disp"		//if (strlen(photonenergy)>0)	//   suffix+=photonenergy+"eV"	//   suffix=replacestring(".",suffix,"_")	//endif	dispName = dispNameBase+suffix		String savepath="root:gold:NormWaves:"	SetDatafolder $savepath	UdispName = dispName	if (waveexists($dispName))			DoAlert 1, "A wave with the name '"+dispName+"' already existed in ':NormWaves'.\r Yes: Overwrite, No: Generated the new wave?"		if (v_flag==1)		else		UdispName = uniqueName(dispName,1,0)		endif	endif		String notestr	notestr=note(basedispersion)	Variable baseef=NumberByKey("BaseFermiEnergy",notestr,"=","\r")		Duplicate/o basedispersion $(savepath+UdispName)	//wave_save_proc((Topimage+";"),root:gold,0)	Wave newdispersion=$UdispName	newdispersion+=w_ef-baseef		Wave w_image=DFR_common:w_image		String newnotestr = NewDispwave_note(w_image)	newnotestr=replacenumberbykey("FermiEnergy",newnotestr,mean(newdispersion),"=","\r")	note /K newdispersion	note newdispersion, newnotestr		print "//- saved '"+UdispName+"' in: 'root:gold:NormWaves'"	       SetDatafolder DFEndstatic Function plot_Hist(ctrlName)	String ctrlName	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		Wave resolution_hist=DFR_panel:w_resolution_hist		display resolution_hist		Modifygraph mode=6		CurveFit/Q/M=2/W=0 gauss, w_resolution_hist/D		Wave W_coef		String text = "Resolution="+num2str(W_coef[2]*1000)+"(meV)"	TextBox/C/N=text0/A=RT text		SetDatafolder DF	Endstatic Function plot_fit(ctrlName)	String ctrlName		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		WAVE edc = DFR_common:n_edc	WAVE w_image =  DFR_common:w_image		WAVE Ffit=n_Ffit	NVAR fp0 = gv_fp0	NVAR fp1 = gv_fp1	NVAR fp2 = gv_fp2	NVAR fp3 = gv_fp3	NVAR fp4 = gv_fp4	NVAR fp5 = gv_fp5	NVAR fp6 = gv_fp6		String imageName = StringByKey("WaveName", note(w_image), "=","\r")	String edcName, fitName, text		ControlInfo global_ck3	if(v_value)		edcName = "e_"+imageName[2,strlen(imagename)-1]+"_all"	// collapsed EDC's	else		edcName = "e_"+imageName[2,strlen(imagename)-1]+"_"+num2str(pcsr(B))	// single EDC	endif	fitName = edcName + "_Ffit"		//NewDataFolder/o/s root:DCs	//NewDataFolder/o/s Fermi	Duplicate/o edc $edcName	Duplicate/o Ffit $fitName		Display $edcName, $fitName	ModifyGraph lsize=0.6,rgb($edcName)=(0,0,0)	Label left "Intensity (kcts/s/channel)"	Label bottom "Energy (eV)"		Variable i0 = fp2 + fp3*fp4	Variable b0 = fp0 + fp1*fp4	text = "Intensity @ EF="+num2str(i0)+"\r"	text += "Background @ EF = "+num2str(b0)+"\r"	text += "Fermi-Level="+num2str(fp4)+"(eV)\r"	text += "Temperature="+num2str(fp5)+"(K)\r"	text += "Resolution="+num2str(fp6*1000)+"(meV)"	TextBox/C/N=text0/A=LB text		//print "//- saved the waves: '"+edcName+"', '"+fitName+"' in the folder: 'root:DCs:Fermi:'" 	SetDataFolder DFEnd//gold panel Tmf Tab controlstatic Function save_tmf(ctrlName)	String ctrlName		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		SVAR dispNameBase = gs_w_dispNameBase	Wave waveVars=DFR_common:WaveVars	SVAR Topimage=DFR_common:gs_TopItemPath	NVAR gv_E0=DFR_common:gv_E0	NVAR gv_E1=DFR_common:gv_E1	 	String dispName, UdispName, finalDispName, Number, suffix			//String photonenergy=num2str(waveVars[6])	suffix = "_aTMF"		//if (strlen(photonenergy)>0)	 //  suffix+=photonenergy+"eV"	 //  suffix=replacestring(".",suffix,"_")	//endif	dispName = dispNameBase+suffix		if (stringmatch(ctrlname,"tmf_b13"))	WAVE w_norm = DFR_panel:w_norm_s	else	WAVE w_norm = DFR_panel:w_norm	endif		String savepath="root:gold:NormWaves:"	SetDatafolder $savepath	UdispName = dispName	if (waveexists($dispName))			DoAlert 1, "A wave with the name '"+dispName+"' already existed in ':NormWaves'.\r Yes: Overwrite, No: Generated the new wave?"		if (v_flag==1)		else		UdispName = uniqueName(dispName,1,0)		endif	endif		Duplicate/o w_norm $(savepath+UdispName)	Wave savetmf=$(savepath+UdispName)		Wave w_image=DFR_common:w_image	String notestr = NewDispwave_note(w_image)	//notestr=replacenumberbykey("FermiEnergy",notestr,mean(w_disp),"=","\r")	notestr+="Energyfrom=\r"	notestr+="EnergyTo=\r"	notestr=replacenumberbykey("Energyfrom",notestr,gv_E0,"=","\r")   	notestr=replacenumberbykey("Energyto",notestr,gv_E1,"=","\r")   		Note /K savetmf	note savetmf,notestr		//wave_save_proc((Topimage+";"),root:gold,0)	print "//- saved '"+UdispName+"' in: 'root:gold:NormWaves'"		SetDataFolder DF	Endstatic Function make_w_tmf(w_image)	WAVE w_image	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		Wave w_image=DFR_common:w_image	SVAR path = DFR_common:gs_TopItemPath		Make/o/n=(dimsize(w_image,0)) w_norm,w_norm_s	//, w_tmf	Variable ch0 = Scienta_ch(w_image,0)	Variable ch1 = Scienta_ch(w_image,1)	SetScale/I x ch0, ch1, w_norm,w_norm_s	//, w_tmf		//String notestr = note(w_image)	//String imagefile = StringByKey("FileName", notestr, "=", "\r")	//String wName = StringByKey("WaveName", notestr,"=","\r")		//Note w_norm, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels\rEnergyFrom=\rEnergyTo=\r"	//Note w_norm_s, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels\rEnergyFrom=\rEnergyTo=\r"	//Note w_tmf, "SourceFileName="+imagefile+"\rSourceWave="+path+"\rScaling=channels"			SetdataFolder DfEndstatic Function default_E0E1_gold(ctrlname)	String ctrlname	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		WAVE w_image = DFR_common:w_image	Variable n = 30		// lowest or highest n-MDC's to average   	NVAR e0 = DFR_common:gv_E0 	NVAR e1 = DFR_common:gv_E1		if(stringmatch(ctrlName, "tmf_b5"))		// low		e0 = dimoffset(w_image,1)		e1 = e0 + n * dimdelta(w_image,1)	elseif(stringmatch(ctrlName, "tmf_b6"))	// high		e0 = M_y1(w_image) - n* dimdelta(w_image,1)		e1 = M_y1(w_image)	endif		Variable temp1,temp2	temp1=e0	temp2=e1	Cursor/P/I/H=1 A w_image pcsr(A),x2pntsmult(w_image,temp2,1)	Cursor/P/I/H=1 B w_image pcsr(B),x2pntsmult(w_image,temp1,1)		SetDatafolder DFEndstatic Function show_TMF(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		WAVE w_image = DFR_common:w_image	WAVE n_mdc = DFR_common:n_mdc	Wave n_edc2 = DFR_common:n_edc2	WAVE w_Norm		//	if(checked)			if (!waveexists(w_Norm))				make_w_tmf(w_image)			else				Wave w_norm				if (numpnts(w_norm)!=dimsize(w_image,0))					make_w_tmf(w_image)				endif			endif			WAVE w_norm 			Wave w_norm_s			AppendToGraph n_edc2			RemoveFromGraph/Z n_Ffit_x,w_dispersion,w_dispersion_s,n_mdc,w_norm,w_norm_s			DeleteBasednamegraph(winname(0,65),"*_disp*",1)			DeleteBasednamegraph(winname(0,65),"*_atmf*",1)			AppendTograph w_norm,w_norm_s			ModifyGraph mode(w_norm)=3,marker(w_norm)=19,msize(w_norm)=1			ModifyGraph rgb(w_norm_s)=(0,0,52224)			new_TMF("dummy")		//else		//	AppendToGraph n_mdc		//	ModifyGraph rgb(n_mdc)=(1,16019,65535)			RemoveFromGraph/Z n_edc2	//	endif		Checkbox tmf_c10,value=1	SetDataFolder DFEndstatic Function new_TMF(ctrlName)	String ctrlName	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		WAVE w_image = DFR_common:w_image		NVAR from =  DFR_common:gv_E0	NVAR to =  DFR_common:gv_E1	WAVE w_tmf = w_norm	WAVE w_tmf_s = w_norm_s		//make_w_disp(w_image)		M_avg_subrange(w_image,0,from,to)	WAVE w_avg	w_tmf = w_avg	w_tmf_s = w_tmf	KillWaves/Z w_avg	SetDataFolder DFEndstatic Function Proc_tmf_energychange(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlname	Variable varnum	String varSTr,varname		DFREF DF = GetDataFolderDFR()	String Name_win=winname(0,65)	SetActivesubwindow $winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")			// lowest or highest n-MDC's to average	WAVE w_image = DFR_common:w_image		//if (stringmatch(ctrlname,"disp_sv0")||stringmatch(ctrlname,"scale_sv0"))	//Cursor/P/I/H=1 B w_image pcsr(B),x2pntsmult(w_image,varnum,1)	//endif		if (stringmatch(ctrlname,"tmf_*"))		NVAR e0 = DFR_common:gv_E0	NVAR e1 = DFR_common:gv_E1	NVAR m0 = DFR_common:gv_M0	NVAR m1 = DFR_common:gv_M1		Variable temp1,temp2		temp1=e0	temp2=e1	Cursor/P/I/H=1 A w_image pcsr(A),x2pntsmult(w_image,temp2,1)	Cursor/P/I/H=1 B w_image pcsr(B),x2pntsmult(w_image,temp1,1)			SetDatafolder DF	endifEndstatic Function Proc_button_Guessnormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	SetActivesubwindow $winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_norm=$"root:gold:normwaves:"	DFREF dFR_load=$DF_global		SVAR wavenamelist=dFR_load:Loadwavelist	SVAR wavenotelist=dFR_load:LoadwaveNotes		Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel		String savename1,notestr1	String savename2,notestr2	Variable index=0	Variable wavenum1,wavenum2	Variable goldnum1,goldnum2	Variable goldsum=0		Variable temp1,temp2		do		if (index>=numpnts(w_dispNames))			break		endif		if (goldsum==2)			break		endif				if (goldsum==0)			if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))				Wave wave_normlist=DFR_norm:$w_dispNames[index]				notestr1=note(wave_normlist)				savename1=stringbykey("SourceFileName",notestr1,"=","\r")//w_dispNames[index]				wavenum1=whichlistitem(savename1,wavenamelist,"\r",0)				temp1=strsearch(savename1,".",inf,1)				temp2=strsearch(savename1,"_",inf,1)				goldnum1=str2num(savename1[temp2+1,temp1-1])								if (wavenum1==-1)					index+=1						continue				endif				notestr1=stringfromlist(wavenum1,wavenotelist,"\r")				goldsum+=1				index+=1					continue			endif		endif				if (goldsum==1)			if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))				Wave wave_normlist=DFR_norm:$w_dispNames[index]				notestr2=note(wave_normlist)				savename2=stringbykey("SourceFileName",notestr2,"=","\r")//w_dispNames[index]				wavenum2=whichlistitem(savename2,wavenamelist,"\r",0)				temp1=strsearch(savename2,".",inf,1)				temp2=strsearch(savename2,"_",inf,1)				goldnum2=str2num(savename2[temp2+1,temp1-1])				if (wavenum2==-1)					index+=1						continue				endif				notestr2=stringfromlist(wavenum2,wavenotelist,"\r")				goldsum+=1				index+=1					continue			endif		endif	index+=1		while (index<numpnts(w_dispNames))		if ((numtype(goldnum1)==2)||(numtype(goldnum2)==2))		SetDatafolder DF		return 0	endif		goldsum=(goldnum2-goldnum1)+1		Wave /T w_createnorm=DFR_panel:w_createnorm		Wave w_createnorm_sel=DFR_panel:w_createnorm_sel	NVAR gv_createnum=DFR_panel:gv_createnum	gv_createnum=goldsum-2		Make /o/n=(goldsum) w_createnorm_time		redimension /n=(goldsum) w_createnorm,w_createnorm_sel	w_createnorm_sel=2		w_createnorm[0]=Stringbykey("NumberofSweeps",notestr1,"=",";")	w_createnorm[goldsum-1]=Stringbykey("NumberofSweeps",notestr2,"=",";")		String basename,extname	basename=savename2[0,temp2]	extname=savename2[temp1,inf]	Variable numbernum=strlen(savename2[temp2+1,temp1-1])	String tempnumstr,tempwavename		Variable month,day,year,hour,mintime,timesec	String AMPM		index=1	do		tempnumstr="000"+num2str(index+goldnum1)		tempnumstr=tempnumstr[(strlen(tempnumstr)-numbernum),inf]		tempwavename=basename+tempnumstr+extname		wavenum1=whichlistitem(tempwavename,wavenamelist,"\r",0)		notestr1=stringfromlist(wavenum1,wavenotelist,"\r")		w_createnorm[index]=Stringbykey("NumberofSweeps",notestr1,"=",";")						String datestr=stringbykey("Date",notestr1,"=",";")		String timestr=stringbykey("Time",notestr1,"=",";")		sscanf datestr,"%g/%g/%g",month,day,year		sscanf timestr,"%g:%g %s",hour,mintime,AMPM		if (hour!=12)			timesec=date2secs(year,month,day)+hour*3600+mintime*60			if (stringmatch(AMPM,"PM"))				timesec+=12*3600			endif		else			timesec=date2secs(year,month,day)+mintime*60			if (stringmatch(AMPM,"PM"))				timesec+=12*3600			endif		endif		w_createnorm_time[index]=timesec//Stringbykey("NumberofSweeps",notestr1,"=",";")		index+=1	while (index<(goldsum-1))		SetDatafolder DFENDstatic Function Proc_button_Fitcreatenormwave(ctrlname)	String ctrlname		DFREF DF=GetdatafolderDFR()	SetActivesubwindow $winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_norm=$"root:gold:normwaves:"		Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames		DFREF dFR_load=$DF_global		SVAR wavenamelist=dFR_load:Loadwavelist	SVAR wavenotelist=dFR_load:LoadwaveNotes		SetDatafolder DFR_panel	String fitwname=winname(1,1)		String tracelist=tracenamelist(fitwname,";",1)	String tracename=stringfromlist(0,tracelist)	Wave golddisp=TraceNameToWaveRef(fitwname, tracename )	Wave xtime=XWaveRefFromTrace(fitwname, tracename )		CurveFit/M=2/W=0 exp_XOffset, golddisp/X=xtime /D//=golddisp_fit		Wave w_coef	Wave W_fitConstants	Duplicate /o golddisp,golddisp_fit	redimension /n=(1000) golddisp_Fit	Setscale /I x,xtime[0],xtime[inf],golddisp_Fit	golddisp_Fit=W_coef[0]+W_coef[1]*exp(-(x-W_fitConstants[0])/W_coef[2])		Appendtograph /W=$fitwname golddisp_Fit 	ModifyGraph  /W=$fitwname rgb(golddisp_Fit)=(0,0,0)		String savename		Variable index=0	Variable ckvalue=0,deviation	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index][0]			if (ckvalue==0)				savename=w_dispNames[index]				deviation=mean(wave_normlist)				duplicate /o wave_normlist w_meanwave				ckvalue=1			else				deviation=mean(wave_normlist)-deviation				break			endif		endif	index+=1		while (index<numpnts(w_dispNames))		Variable autonameflag	prompt autonameflag,"Select name method", popup,"Step name; Same name;"	prompt savename,"based wave name:"	DoPrompt "Auto Create:",autonameflag, savename	If (V_FLAG)		SetDatafolder DF		return 1	endif			if (autonameflag==1)		variable temppos=strsearch(savename,"_disp",inf,-1)		String basename=savename[0,temppos-4]		String stepname=savename[temppos-3,temppos-1]	endif			Wave w_createnorm_time=DFR_panel:w_createnorm_time		duplicate /o w_createnorm_time,w_creategold	w_creategold[0]=Nan	w_creategold[inf]=Nan	w_createnorm_time[0]=Nan	w_createnorm_time[inf]=Nan	index=1	do		Duplicate /o w_meanwave,w_meanwave_temp		w_meanwave_temp=w_meanwave+(golddisp_fit(w_createnorm_time[index])-mean(w_meanwave))		w_creategold[index]=mean(w_meanwave_temp)		if (autonameflag==1)			sprintf savename,basename+"%03g"+"_disp",(str2num(stepname)+index)		endif		Save_norm_wave(DFR_norm,w_meanwave_temp,savename,mean(w_meanwave_temp),2)					index+=1	while (index<(numpnts(w_createnorm_time)-1))			Appendtograph /W=$fitwname w_creategold vs w_createnorm_time	ModifyGraph  /W=$fitwname mode(w_creategold)=3,marker(w_creategold)=8		SetDatafolder DFEndstatic Function Proc_button_createnormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	SetActivesubwindow $winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_norm=$"root:gold:normwaves:"	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel	String savename		Variable index=0	Variable ckvalue=0,deviation	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index][0]			if (ckvalue==0)				savename=w_dispNames[index]				deviation=mean(wave_normlist)				duplicate /o wave_normlist w_meanwave				ckvalue=1			else				deviation=mean(wave_normlist)-deviation				break			endif		endif	index+=1		while (index<numpnts(w_dispNames))		Variable autonameflag	prompt autonameflag,"Select name method", popup,"Step name; Same name;"	prompt savename,"based wave name:"	DoPrompt "Auto Create:",autonameflag, savename	If (V_FLAG)		SetDatafolder DF		return 1	endif			if (autonameflag==1)		variable temppos=strsearch(savename,"_disp",inf,-1)		String basename=savename[0,temppos-4]		String stepname=savename[temppos-3,temppos-1]	endif		Wave /T w_createnorm=DFR_panel:w_createnorm		index=0	make /o/n=(numpnts(w_createnorm)-1) w_createnorm_temp	do		if (index>0)			w_createnorm_temp[index-1]=(str2num(w_createnorm[index-1])+str2num(w_createnorm[index]))/2		endif		index+=1	while (index<numpnts(w_createnorm))	Variable totald=sum(w_createnorm_temp),eachd=0	index=0	do		eachd=deviation/totald*w_createnorm_temp[index]		w_meanwave+=eachd		if (autonameflag==1)			sprintf savename,basename+"%03g"+"_disp",(str2num(stepname)+index+1)		endif		Save_norm_wave(DFR_norm,w_meanwave,savename,mean(w_meanwave),2)			index+=1	while (index<(numpnts(w_createnorm_temp)-1))		SetDatafolder DFEndstatic Function Proc_Setvariable_Setcreatenum(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	// value of variable as number	String varStr		// value of variable as string	String varName	// name of variable	DFREF DF=GetdatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"		Wave /T w_createnorm=DFR_panel:w_createnorm	Wave  w_createnorm_sel=DFR_panel:w_createnorm_sel		redimension /N=(varnum+2) w_createnorm, w_createnorm_sel	//w_createnorm="1" //don't initial	w_createnorm_sel=2	Endstatic Function Proc_button_copynormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel	String savename	Variable index=0	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			savename=w_dispNames[index]			Wave wave_normlist=DFR_norm:$w_dispNames[index]		  //  duplicate /o wave_normlist w_meanwave		    break		endif	index+=1		while (index<numpnts(w_dispNames))	if (stringmatch(ctrlname,"Normlist_b3"))		duplicate /o wave_normlist w_dispersion,w_dispersion_s	endif	SetDatafolder DFEndstatic Function Proc_button_dispEFvsTime(ctrlname)	String ctrlname		DFREF DF=GetdatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"	DFREF dFR_load=$DF_global		SVAR wavenamelist=dFR_load:Loadwavelist	SVAR wavenotelist=dFR_load:LoadwaveNotes			Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel		Make /o/n=0 EF_value	Make /D/o/n=0 EF_time	Setscale d,0,0,"dat",EF_time		String savename,notestr,datestr,timestr	Variable index=0	Variable wavenum	Variable year,month,day,hour,mintime,timesec,selindex	String AMPM	do		if (index>=numpnts(w_dispNames))			break		endif		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index]			notestr=note(wave_normlist)			savename=stringbykey("SourceFileName",notestr,"=","\r")//w_dispNames[index]			wavenum=whichlistitem(savename,wavenamelist,"\r",0)			if (wavenum==-1)				index+=1					continue			endif			notestr=stringfromlist(wavenum,wavenotelist,"\r")			datestr=stringbykey("Date",notestr,"=",";")			timestr=stringbykey("Time",notestr,"=",";")			sscanf datestr,"%g/%g/%g",month,day,year			sscanf timestr,"%g:%g %s",hour,mintime,AMPM			if (hour!=12)				timesec=date2secs(year,month,day)+hour*3600+mintime*60				if (stringmatch(AMPM,"PM"))					timesec+=12*3600				endif			else				timesec=date2secs(year,month,day)+mintime*60				if (stringmatch(AMPM,"PM"))					timesec+=12*3600				endif			endif			insertpoints inf,1,EF_value,EF_time			EF_time[selindex]=timesec			EF_value[selindex]=mean(wave_normlist)			selindex+=1		    //duplicate /o wave_normlist w_meanwave		endif	index+=1		while (index<numpnts(w_dispNames))		display_XYwave(EF_value,EF_time,0,0)		ModifyGraph mode(EF_value)=4,marker(EF_value)=19	SetDatafolder DF	Endstatic Function Proc_button_shiftnormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel	String savename	Variable index=0	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			savename=w_dispNames[index]			Wave wave_normlist=DFR_norm:$w_dispNames[index]		    duplicate /o wave_normlist w_meanwave		    break		endif	index+=1		while (index<numpnts(w_dispNames))		Variable shiftvalue	prompt shiftvalue,"Shift (meV):"	prompt savename,"Wave name:"	DoPrompt "Save as:",savename,shiftvalue	If (V_FLAG)		SetDatafolder DF		return 1	endif	w_meanwave+=shiftvalue/1000	Save_norm_wave(DFR_norm,w_meanwave,savename,mean(w_meanwave),1)	SetDatafolder DFendstatic Function Save_norm_wave(DFR_norm,w_normwave,savename,EF,flag)	DFREF DFR_norm	Wave w_normwave	String savename	Variable ef,flag	DFREF DF=GetdatafolderDFR()		SetDatafolder DFR_norm	String	UdispName = saveName	if (flag==1)		if (waveexists($saveName))			DoAlert 1, "A wave with the name '"+saveName+"' already existed in ':NormWaves'.\r Yes: Overwrite, No: Generated the new wave?"			if (v_flag==1)			else				UdispName = uniqueName(saveName,1,0)			endif		endif	elseif (flag==2)		UdispName = uniqueName(saveName,1,0)	else	endif		Duplicate/o w_normwave DFR_norm:$UdispName	//wave_save_proc((Topimage+";"),root:gold,0)	print "//- saved '"+UdispName+"' in: 'root:gold:NormWaves'"	String notestr	Wave newdispersion=$UdispName   	 notestr=note(newdispersion)    //Variable baseef=NumberByKey("FermiEnergy",notestr,"=","\r")   // newdispersion+=w_ef-baseef   	String sourcefilename=stringbykey("SourceFileName",notestr,"=","\r")+"_Create"   	String sourcewavename=stringbykey("SourceWave",notestr,"=","\r")+"_Create"  	notestr=replacestringbykey("Sourcefilename",notestr,sourcefilename,"=","\r")  	notestr=replacestringbykey("SourceWave",notestr,sourcewavename,"=","\r")  	notestr=replacenumberbykey("FermiEnergy",notestr,ef,"=","\r")	note /K newdispersion	note newdispersion, notestr    SetDatafolder DFEndstatic Function Proc_button_Setnormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel	String savename	Variable index=0	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			savename=w_dispNames[index]			Wave wave_normlist=DFR_norm:$w_dispNames[index]		    duplicate /o wave_normlist w_meanwave		    break		endif	index+=1		while (index<numpnts(w_dispNames))	index=0	Wave w_meanwave	w_meanwave=0	Variable cindex=0	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index]		    w_meanwave+=wave_normlist		    cindex+=1		endif	index+=1		while (index<numpnts(w_dispNames))		w_meanwave/=cindex	prompt savename,"Wave name:"	DoPrompt "Save as:",savename	If (V_FLAG)		SetDatafolder DF		return 1	endif	Save_norm_wave(DFR_norm,w_meanwave,savename,mean(w_meanwave),1)	SetDatafolder DFEndstatic Function Proc_button_delnormwave(ctrlname)	String ctrlname	DFREF DF=GetdatafolderDFR()	String Name_win=winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_norm=$"root:gold:normwaves:"	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	Wave /T w_dispNames=DFR_panel:w_dispNames	SetDatafolder DFR_panel	Variable index=0	do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index][0]		    Killwaves /Z wave_normlist		endif	index+=1		while (index<dimsize(w_dispNames,0))	gold_updatenormwave_List()	Wave /T w_dispNames=DFR_panel:w_dispNames	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	show_Multi_Normwave(w_dispNames,w_dispNames_sel)	SetDatafolder DFEndstatic Function Proc_checkbox_normwavesel(ctrlname,value)	String ctrlname	Variable value	DFREF DF=GetdatafolderDFR()	String Name_win=winname(0,65)	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)		Variable ckvalue	strswitch (ctrlname)	case "NormList_ck0":	ckvalue=0	break	case "NormList_ck1":	ckvalue=1	break	Endswitch	checkbox NormList_ck0,value=ckvalue==0	checkbox NormList_ck1,value=ckvalue==1	gold_updatenormwave_List()	Wave /T w_dispNames=DFR_panel:w_dispNames	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	show_Multi_Normwave(w_dispNames,w_dispNames_sel)	SetDatafolder DFEndstatic Function show_Multi_Normwave(w_dispNames,w_dispNames_sel)	Wave /T w_dispNames	Wave w_dispNames_sel    DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_common= $(DF_panel+":panel_common")	DFREF DFR_norm=$"root:gold:normwaves:"		WAVE n_edc2 = DFR_common:n_edc2	WAVE n_mdc = DFR_common:n_mdc	SVAR gs_meanvalue=DFR_panel:gs_meanvalue	SVAR gs_deviation=DFR_panel:gs_deviation		SetDatafolder DFR_panel		AppendToGraph n_edc2	// first append a dummy to avoid having no wave on the graph	RemoveFromGraph/Z n_Ffit_x,n_mdc, w_dispersion	RemoveFromGraph/Z w_dispersion_s, w_resolution,w_norm,w_norm_s	DeleteBasednamegraph(winname(0,65),"*_disp*",1)	DeleteBasednamegraph(winname(0,65),"*_atmf*",1)		if (numpnts(w_dispNames)==0)		AppendToGraph n_mdc		ModifyGraph rgb(n_mdc)=(1,16019,65535)		RemoveFromGraph/Z  n_edc2		SetDatafolder DF		return 1	endif		if (sum(w_dispNames_sel)==0)	w_dispNames_sel=0	w_dispNames_sel[0]=1	endif		Make/o/n=1 Meanwave	Meanwave=0		Variable index=0,meanvalue,deviation,cindex=0	Variable trace_colorindex=0		DFREF DFR_GP=$DF_GP	//NVAR colorIndex=DFR_GP:gv_colorIndex	SetDatafolder DFR_GP	String Colorwavelist=wavelist("Color_*",";","")	wave color_w=$Stringfromlist(0,ColorWavelist,";")		SetDatafolder DFR_panel		do		if ((w_dispNames_sel[index]==1)||(w_dispNames_sel[index]==8)||(w_dispNames_sel[index]==9))			Wave wave_normlist=DFR_norm:$w_dispNames[index][0]			Insertpoints inf,1,Meanwave			Meanwave[cindex]=mean(wave_normlist)			cindex+=1			String uniquenames=w_dispNames[index][0]//UniqueName("wave_normlist", 1, 0 , DF_panel)			duplicate /o wave_normlist $uniquenames			Wave wave_normlist=$uniquenames			appendtograph wave_normlist			ModifyGraph rgb($uniquenames) = (color_w[trace_colorindex][0],color_w[trace_colorindex][1],color_w[trace_colorindex][2])			trace_colorindex+=1					endif	index+=1		while (index<dimsize(w_dispNames,0))	Deletepoints (numpnts(meanwave)-1),1,Meanwave	Meanvalue=mean(Meanwave)	deviation=abs(Wavemax(meanwave)-wavemin(meanwave))		controlinfo NormList_ck0	if (v_value)	gs_meanvalue=num2str(Meanvalue)+" eV"	gs_deviation=num2str(deviation*1000)+" meV"	else	gs_meanvalue=num2str(Meanvalue)//+" eV"	gs_deviation=num2str(deviation*1000)//+" meV"	endif	RemoveFromGraph/Z  n_edc2	Killwaves /Z meanwave		SetDatafolder DF	endstatic Function Proc_listbox_goldNormNames(ctrlname, row, col, event)	String ctrlName	Variable row	Variable col	Variable event		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)	DFREF DFR_common= $(DF_panel+":panel_common")//	SVAR panelprocPath=DFR_panel:panelprocPath	//DFREF DFR_normal=$panelprocPath		//wave w_image=DFR_common:w_image		SetDatafolder DFR_panel				if (event == 1 || event == 4)	// update wave-list		gold_updatenormwave_List() 	endif		if (event == 4|| event == 5)	// update top-path and display-wave		Wave w_dispNames=DFR_panel:w_dispNames		Wave w_dispNames_sel=DFR_panel:w_dispNames_sel		show_Multi_Normwave(w_dispNames,w_dispNames_sel)	endif	SetDatafolder DF	return 0Endstatic Function gold_updatenormwave_List()	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetActivesubwindow $winname(0,65)		String suffix	Controlinfo NormList_ck0	If (v_value)		suffix = "*_disp*"	else		suffix = "*_aTMF*"	endif		DFREF DFR_gold=$("root:gold:Normwaves:")	SetDatafolder DFR_gold	Wave /t w_dispNames=DFR_panel:w_dispNames	Wave w_dispNames_sel=DFR_panel:w_dispNames_sel	String List = wavelist(suffix,";","DIMS:1")//List_of_waves("root:carpets:normalized:NormWaves:", suffix, 1, 0)	if (strlen(List)==0)		redimension /n=(0,4),w_dispNames,w_dispNames_sel		SetDatafolder DF		return 0	endif		SListToWave(List,1,";",Nan,Nan)	Wave /t w_Stringlist	redimension /n=(numpnts(w_Stringlist),4),w_dispNames,w_dispNames_sel	w_dispNames[][0]=w_Stringlist[p]	//duplicate/t/o w_StringList data	KillWaves/Z w_StringList		variable index	do 		Wave dispWave=DFR_gold:$w_dispNames[index][0]		readDispwave_note(dispWave)		Wave /Z /T w_readingresult		w_dispNames[index][1]=w_ReadingResult[4]		w_dispNames[index][2]=w_ReadingResult[5]		w_dispNames[index][3]=w_ReadingResult[6]			index+=1	while (index<dimsize(w_dispNames,0))	Killwaves /Z w_readingresult		if (sum(w_dispNames_sel)==0)	w_dispNames_sel=0	w_dispNames_sel[0]=1	endifSetDatafolder DF	End////////////////////////////////////////////Core Function//////////////////////////static Function FF_one_or_all(ctrlName)	String ctrlName		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel			NVAR fp0 = gv_fp0		NVAR fp1 = gv_fp1		NVAR fp2 = gv_fp2		NVAR fp3 = gv_fp3		NVAR fp4 = gv_fp4	NVAR fp5 = gv_fp5	NVAR fp6 = gv_fp6	NVAR goldei=DFR_common:gv_E0//gv_goldEi	NVAR goldef=DFR_common:gv_E1//gv_goldEf	Variable p0,p1		WAVE FF_pw	FF_pw = {fp0, fp1, fp2, fp3, fp4, fp5, fp6}		WAVE n_EDC = DFR_common:n_edc	WAVE w_image = DFR_common:w_image		p0=x2pnt(n_EDC,goldei)	p1=x2pnt(n_EDC,goldef)	Duplicate/o n_EDC n_Ffit n_Ffit_x	n_Ffit_x = x	n_FFit=nan	RemoveFromGraph/Z n_Ffit_x	AppendToGraph/Q/L=edc_en/B=edc_int n_Ffit_x vs n_Ffit		// hold-string	String cb, holdstr = ""	Variable index = 0	do		cb = "disp_c_"+ num2str(index)	// name of the checkbox		ControlInfo $cb		holdstr+= num2str(v_value)	index += 1	while(index <= 6)		WAVE w_dispersion	WAVE w_dispersion_s	WAVE w_resolution		Make /o/T/n=2/Free ConstrainWave	ConstrainWave[0]="K6 > 0"	ConstrainWave[1]="K2 > 0"		index = 0	// fit the current EDC	if (stringmatch(ctrlName,"disp_b_1"))			FermiGauss_init(n_EDC,FF_pw[6],1e-4)	// 0.1 meV step size			//	FuncFit /Q/H = holdstr FermiGauss  FF_pw n_EDC/D = n_Ffit		Duplicate/o FF_pw FF_epsilon		// added 10-05-04 to improve convergence (without much understanding...)		FF_epsilon=1e-6						FuncFit /N/Q/H = holdstr FermiGauss  FF_pw n_EDC[p0,p1] /E=FF_epsilon /D = n_Ffit /C=ConstrainWave				fp0 = FF_pw[0]; fp1 = FF_pw[1]; fp2 = FF_pw[2]; fp3 = FF_pw[3]; fp4 = FF_pw[4]; fp5 = FF_pw[5]; fp6 = FF_pw[6]				// fit all EDC's	elseif (stringmatch(ctrlName,"disp_b_2"))			Checkbox global_ck3, value = 0		Duplicate/o FF_pw FF_epsilon			FF_epsilon=1e-6					w_dispersion = fp4		w_dispersion_s=fp4		w_resolution = fp6			do			n_edc = w_image[index][p]							FermiGauss_init(n_EDC,FF_pw[6],4e-4)// 1 meV step size!! // changed to 0.4 meV step size 07-01-04			//FuncFit /N/Q/H = holdstr FermiGauss  FF_pw n_EDC/D = n_Ffit			/////////////////////////////////////////						wavestats/Q n_edc			Duplicate/o n_edc w_guess			Smooth 30, w_guess			Differentiate w_guess	// now we should have a Gaussian			CurveFit/q gauss w_guess 			WAVE w_coef			KillWaves/ z w_guess			FF_pw[0]= v_min		FF_pw[1] = 0		FF_pw[2] = v_max-v_min		FF_pw[3]= 0		FF_pw[4]= w_coef[2]				FF_pw[6]= sqrt((2.335* w_coef[3])^2 - (13 * deltax(temp_EDC))^2)	// igor width to full width & corrected for smoothing broadening		if (numtype(FF_pw[6])==2)			FF_pw[6]=0.01		endif				//sdc change fitting range here		goldei=w_coef[2]-0.05		goldef=w_coef[2]+0.05						///////////////////////////////				n_Ffit=NaN			FuncFit /N/Q/H = holdstr FermiGauss  FF_pw n_EDC(goldei,goldef) /E=FF_epsilon/D = n_Ffit /C=ConstrainWave			//print goldei			fp0 = FF_pw[0]; fp1 = FF_pw[1]; fp2 = FF_pw[2]; fp3 = FF_pw[3]; fp4 = FF_pw[4]; fp5 = FF_pw[5]; fp6 = FF_pw[6]			w_dispersion[index] = fp4			w_dispersion_s[index]=fp4			w_resolution[index] = fp6			//////					DoUpdate		index += 1		while (index < dimsize(w_image,0))				Make /o/n=50 w_resolution_hist		Histogram w_resolution, w_resolution_hist	endif		SetdataFolder DfEnd// generate the waves for the convolution// yw is a waveform// fwhm the initial guess for the Gaussian full width in units of the wave form (fitted width should be less than 2 times larger than initial guess!!)// dx the step size of the Gaussian in units of the waveformFunction FermiGauss_init(yw,fwhm,dx)	WAVE yw; Variable fwhm, dx		DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	SetDatafolder DFR_panel		Variable xmin =  pnt2x(yw,0)	Variable xmax = pnt2x(yw,numpnts(yw)-1)	Variable xrange = 2*(xmax - xmin)	Variable from = round( (xmin - xrange)/dx) * dx//-0.1	Variable to = round( (xmax + xrange)/dx) * dx//0.1		Variable fpoints = abs(to-from)/dx +1	// point number for the Fermi waves	Make/D/O/N=(fpoints) w_FermiF	SetScale/I x from,to, w_FermiF	Duplicate/o w_FermiF w_FermiG w_InternalXValues	w_InternalXValues=x	// x-wave for w_FermiG		Variable gpoints	 = round(abs((3*fwhm)/dx))*2+1  	// optimal point number for the Gaussian (3 fwhm)	Make/D/O/N=(gpoints) w_Gaussian	SetScale/I x -(gpoints-1)/2*dx,(gpoints-1)/2*dx, w_Gaussian		Variable/G gv_Gaussian_dx = dx		// needed by the fitfunction		SetDataFolder DFEndFunction FermiGauss(pw, yw, xw): Fitfunc    Wave pw, yw, xw        DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel		WAVE FermiF = DFR_panel:w_FermiF	WAVE FermiG = DFR_panel:w_FermiG	WAVE InternalXValues = DFR_panel:w_InternalXValues	WAVE Gaussian = DFR_panel:w_Gaussian	NVAR dx = DFR_panel:gv_Gaussian_dx          	Variable kB=8.617385e-5 			//  in eV/K   	FermiF=pw[0]+pw[1]*x + (pw[2]+pw[3]*x)/(exp((x-pw[4]) / (kB*pw[5]))+1.0 )    	FermiG = FermiF   	Variable aux0= 4*ln(2)/pw[6]^2	Gaussian = exp(-x^2*aux0) / ( sqrt(pi/aux0) / dx )		// norm=dx                 	Convolve/A Gaussian FermiG                    	//yw =interp(xw,InternalXvalues,FermiG)    yw = FermiG(xw[p])Endstatic Function Correct_TMF(ctrlname)	String ctrlname    	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel		Wave w_image=DFR_common:w_image		Variable lowenergy=M_y0(w_image)	Variable highenergy=lowenergy+0.05	//print lowenergy,highenergy		Make /o/FREE/n=(dimsize(w_image,1)) TempEDC	Make /o/FREE/n=(dimsize(w_image,0)) TempMDC	Setscale /I x,M_y0(w_image),M_y1(w_image),tempEDC	Variable index	Variable meanvalue	do		tempEDC=w_image[index][p]		TempMDC[index]=mean(tempEDC,lowenergy,highenergy)		index+=1	while (index<dimsize(w_image,0))		w_image/=TempMDC[p]/mean(tempmdc)	panelimageupdate(-1)		SetDatafolder DFEndstatic Function Fermi_guess(ctrlName)	String ctrlname    	DFREF DF = GetDataFolderDFR()	String DF_panel="root:internalUse:"+winname(0,65)	DFREF DFR_panel=$DF_panel	DFREF DFR_common= $(DF_panel+":panel_common")	SetActivesubwindow $winname(0,65)	SetDatafolder DFR_panel			NVAR fp0 = gv_fp0; NVAR fp1 = gv_fp1; NVAR fp2 = gv_fp2; NVAR fp3 = gv_fp3		NVAR fp4 = gv_fp4; NVAR fp5 = gv_fp5; NVAR fp6 = gv_fp6		NVAR SampleTem=DFR_common:gv_sampletem		NVAR goldei=DFR_common:gv_E0//gv_goldEi	NVAR goldef=DFR_common:gv_E1//gv_goldEf	WAVE temp_EDC =DFR_common:n_EDC	Wave w_image=DFR_common:w_image	wavestats/Q temp_EDC	Duplicate/o temp_EDC w_guess	Smooth 13, w_guess	Differentiate w_guess	// now we should have a Gaussian	CurveFit/q gauss w_guess 	WAVE w_coef	KillWaves/ z w_guess		fp0 = v_min	fp1 = 0	fp2 = v_max-v_min	fp3 = 0	fp4 = w_coef[2]	fp5 = (numtype(SampleTem==2))?(10):(SampleTem)	fp6 = sqrt((2.335* w_coef[3])^2 - (13 * deltax(temp_EDC))^2)	// igor width to full width & corrected for smoothing broadening	if (numtype(fp6)==2)	fp6=0.01	endif		goldei=w_coef[2]-0.05	goldef=w_coef[2]+0.05	Make/d/o/n=7 FF_pw={fp0, fp1, fp2, fp3, fp4, fp5, fp6}		Variable temp1,temp2	temp1=goldei	temp2=goldef	Cursor/P/I/H=1 A w_image pcsr(A),x2pntsmult(w_image,temp2,1)	Cursor/P/I/H=1 B w_image pcsr(B),x2pntsmult(w_image,temp1,1)		SetDataFolder DFEnd